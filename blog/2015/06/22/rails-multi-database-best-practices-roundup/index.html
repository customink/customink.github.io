<!DOCTYPE html>
<html>
  <head>
  <title>Rails Multi-Database Best Practices Roundup - CustomInk Technology Blog</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="
  
    
  
  
    Seamless second database integration for Rails.
    
      2016-01-11: We just finished a new version of SecondBase, our own gem...">
  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://technology.customink.com/feed.xml" />
  <style rel="stylesheet" type="text/css">ï»¿/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace, monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:0.35em 0.75em 0.625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}html{box-sizing:border-box}*,*::before,*::after{box-sizing:inherit}html,body{height:100%}body,button,input,select,textarea,pre{margin:0;background-color:white}h1,h2,h3,h4,h5,h6,p,dl,ol,ul{margin-top:0;margin-bottom:1rem}ol,ul{padding-left:2rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0;padding-left:1rem}button{border:0}button,input,select,textarea{font-family:inherit;font-size:100%}textarea{display:block}article,aside,details,figcaption,figure,footer,header,main,nav,section,summary{display:block}.sb-Wrapper{padding-right:1rem;padding-left:1rem}@media (min-width: 43.75em){.sb-Wrapper{width:42.75rem;margin-right:auto;margin-left:auto}}@media (min-width: 64em){.sb-Wrapper{width:63rem;margin-right:auto;margin-left:auto}}@media (min-width: 81.25em){.sb-Wrapper{width:80.25rem;margin-right:auto;margin-left:auto}}.sb-Wrapper--fluid{padding-right:1rem;padding-left:1rem;margin-right:auto;margin-left:auto}.sb-PageWrapper.is-open:before{content:'';display:block;position:absolute;top:0;right:0;bottom:0;left:0;z-index:99999999}.sb-Main{max-width:100%;margin-left:auto;margin-right:auto}.sb-Main:after{content:" ";display:block;clear:both}.sb-Main--content{padding-top:1rem}@media (min-width: 64em){.sb-Main--content{padding-top:1.5rem}}@media (max-width: 43.6875em){html.is-minimalUI{overflow:hidden}html.is-minimalUI .sb-PageWrapper{height:100%;overflow-y:scroll;-webkit-overflow-scrolling:touch}}.sb-Btn,a.sb-Btn,.sb-Btn--primary,a.sb-Btn--primary,.sb-Btn--primaryAlt,a.sb-Btn--primaryAlt,.sb-Form input[type='submit'],.sb-Form input[type='submit'].sb-Btn--primary,.sb-Form input[type='submit'].sb-Btn--primaryAlt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background:#1f51cf;padding:0.65rem 2rem;color:#fff;border-radius:6px;transition:all 0.1s ease-in-out;display:inline-block;text-align:center;position:relative;border:0}.sb-Btn:after,a.sb-Btn:after,.sb-Btn--primary:after,a.sb-Btn--primary:after,.sb-Btn--primaryAlt:after,a.sb-Btn--primaryAlt:after,.sb-Form input[type='submit']:after,.sb-Form input[type='submit'].sb-Btn--primary:after,.sb-Form input[type='submit'].sb-Btn--primaryAlt:after{content:"";position:absolute;width:100%;height:10px;border-radius:6px;bottom:0;left:0;box-shadow:0 -3px 0 rgba(0,0,0,0.6) inset}.sb-Btn:visited,a.sb-Btn:visited,.sb-Btn--primary:visited,a.sb-Btn--primary:visited,.sb-Btn--primaryAlt:visited,a.sb-Btn--primaryAlt:visited,.sb-Form input[type='submit']:visited,.sb-Form input[type='submit'].sb-Btn--primary:visited,.sb-Form input[type='submit'].sb-Btn--primaryAlt:visited{color:#fff}.sb-Btn:hover,a.sb-Btn:hover,.sb-Btn--primary:hover,a.sb-Btn--primary:hover,.sb-Btn--primaryAlt:hover,a.sb-Btn--primaryAlt:hover,.sb-Form input[type='submit']:hover,.sb-Form input[type='submit'].sb-Btn--primary:hover,.sb-Form input[type='submit'].sb-Btn--primaryAlt:hover{color:#fff;background:#1840a3}.sb-Btn:active,.sb-Btn:focus,.sb-Btn.is-Active,a.sb-Btn:active,a.sb-Btn:focus,a.sb-Btn.is-Active,.sb-Btn--primary:active,.sb-Btn--primary:focus,.sb-Btn--primary.is-Active,a.sb-Btn--primary:active,a.sb-Btn--primary:focus,a.sb-Btn--primary.is-Active,.sb-Btn--primaryAlt:active,.sb-Btn--primaryAlt:focus,.sb-Btn--primaryAlt.is-Active,a.sb-Btn--primaryAlt:active,a.sb-Btn--primaryAlt:focus,a.sb-Btn--primaryAlt.is-Active,.sb-Form input[type='submit']:active,.sb-Form input[type='submit']:focus,.sb-Form input[type='submit'].is-Active,.sb-Form input[type='submit'].sb-Btn--primary:active,.sb-Form input[type='submit'].sb-Btn--primary:focus,.sb-Form input[type='submit'].sb-Btn--primary.is-Active,.sb-Form input[type='submit'].sb-Btn--primaryAlt:active,.sb-Form input[type='submit'].sb-Btn--primaryAlt:focus,.sb-Form input[type='submit'].sb-Btn--primaryAlt.is-Active{outline:none;color:#fff;background:#295cdf}.sb-Btn:disabled,.sb-Btn.is-Disabled,a.sb-Btn:disabled,a.sb-Btn.is-Disabled,.sb-Btn--primary:disabled,.sb-Btn--primary.is-Disabled,a.sb-Btn--primary:disabled,a.sb-Btn--primary.is-Disabled,.sb-Btn--primaryAlt:disabled,.sb-Btn--primaryAlt.is-Disabled,a.sb-Btn--primaryAlt:disabled,a.sb-Btn--primaryAlt.is-Disabled,.sb-Form input[type='submit']:disabled,.sb-Form input[type='submit'].is-Disabled,.sb-Form input[type='submit'].sb-Btn--primary:disabled,.sb-Form input[type='submit'].sb-Btn--primary.is-Disabled,.sb-Form input[type='submit'].sb-Btn--primaryAlt:disabled,.sb-Form input[type='submit'].sb-Btn--primaryAlt.is-Disabled{opacity:.3;cursor:not-allowed;pointer-events:none}.sb-Btn--primaryRed,a.sb-Btn--primaryRed,.sb-Form input[type='submit'].sb-Btn--primaryRed{background-color:#fa3c00;transition:all 0.1s ease-in-out}.sb-Btn--primaryRed:active,.sb-Btn--primaryRed:focus,.sb-Btn--primaryRed.is-Active,a.sb-Btn--primaryRed:active,a.sb-Btn--primaryRed:focus,a.sb-Btn--primaryRed.is-Active,.sb-Form input[type='submit'].sb-Btn--primaryRed:active,.sb-Form input[type='submit'].sb-Btn--primaryRed:focus,.sb-Form input[type='submit'].sb-Btn--primaryRed.is-Active{outline:none;color:#fff;background-color:#ff602e !important}.sb-Btn--primaryRed:hover,a.sb-Btn--primaryRed:hover,.sb-Form input[type='submit'].sb-Btn--primaryRed:hover{background:#e13600}.sb-Btn--secondary,a.sb-Btn--secondary,.sb-Form input[type='submit'].sb-Btn--secondary,.sb-Btn--secondaryAlt,a.sb-Btn--secondaryAlt,.sb-Form input[type='submit'].sb-Btn--secondaryAlt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;box-shadow:inset 0px 0px 0px 2px #1f51cf;background:transparent;padding:0.65rem 2rem;color:#1f51cf !important;transition:all 0.1s ease-in-out;display:inline-block;text-align:center}.sb-Btn--secondary:after,a.sb-Btn--secondary:after,.sb-Form input[type='submit'].sb-Btn--secondary:after,.sb-Btn--secondaryAlt:after,a.sb-Btn--secondaryAlt:after,.sb-Form input[type='submit'].sb-Btn--secondaryAlt:after{display:none}.sb-Btn--secondary:hover,.sb-Btn--secondary:focus,.sb-Btn--secondary:active,a.sb-Btn--secondary:hover,a.sb-Btn--secondary:focus,a.sb-Btn--secondary:active,.sb-Form input[type='submit'].sb-Btn--secondary:hover,.sb-Form input[type='submit'].sb-Btn--secondary:focus,.sb-Form input[type='submit'].sb-Btn--secondary:active,.sb-Btn--secondaryAlt:hover,.sb-Btn--secondaryAlt:focus,.sb-Btn--secondaryAlt:active,a.sb-Btn--secondaryAlt:hover,a.sb-Btn--secondaryAlt:focus,a.sb-Btn--secondaryAlt:active,.sb-Form input[type='submit'].sb-Btn--secondaryAlt:hover,.sb-Form input[type='submit'].sb-Btn--secondaryAlt:focus,.sb-Form input[type='submit'].sb-Btn--secondaryAlt:active{background-color:#1f51cf;color:#fff !important}.sb-Btn--secondary--white,a.sb-Btn--secondary--white,.sb-Form input[type='submit'].sb-Btn--secondary--white,.sb-Btn--secondaryAlt--white,a.sb-Btn--secondaryAlt--white,.sb-Form input[type='submit'].sb-Btn--secondaryAlt--white{background-color:#fff}.sb-Btn--link,a.sb-Btn--link,.sb-Form input[type='submit'].sb-Btn--link{border:0;background:transparent;color:#1e39d2 !important;box-shadow:none;transition:all 0.1s ease-in-out}.sb-Btn--link:after,a.sb-Btn--link:after,.sb-Form input[type='submit'].sb-Btn--link:after{display:none}.sb-Btn--link:hover,.sb-Btn--link:focus,.sb-Btn--link:active,a.sb-Btn--link:hover,a.sb-Btn--link:focus,a.sb-Btn--link:active,.sb-Form input[type='submit'].sb-Btn--link:hover,.sb-Form input[type='submit'].sb-Btn--link:focus,.sb-Form input[type='submit'].sb-Btn--link:active{background:transparent;transform:none;box-shadow:none;color:#14278f !important}.sb-Btn--linkAlt,a.sb-Btn--linkAlt,.sb-Form input[type='submit'].sb-Btn--linkAlt{border:2px solid #ededed;box-shadow:none;background-color:#ededed;color:#444 !important;transition:all 0.1s ease-in-out}.sb-Btn--linkAlt:after,a.sb-Btn--linkAlt:after,.sb-Form input[type='submit'].sb-Btn--linkAlt:after{display:none}.sb-Btn--linkAlt:hover,.sb-Btn--linkAlt:focus,.sb-Btn--linkAlt:active,a.sb-Btn--linkAlt:hover,a.sb-Btn--linkAlt:focus,a.sb-Btn--linkAlt:active,.sb-Form input[type='submit'].sb-Btn--linkAlt:hover,.sb-Form input[type='submit'].sb-Btn--linkAlt:focus,.sb-Form input[type='submit'].sb-Btn--linkAlt:active{border-color:#d4d4d4;transform:none;box-shadow:none;color:#444;background:#d4d4d4}.sb-Btn--large,a.sb-Btn--large,.sb-Form input[type='submit'].sb-Btn--large{font-size:1.25rem;font-weight:bold;padding-left:2rem;padding-right:2rem}.sb-Btn--small,a.sb-Btn--small,.sb-Form input[type='submit'].sb-Btn--small{font-size:0.85rem;padding:0.35rem 1.2rem 0.5rem}.sb-Btn--block,a.sb-Btn--block,.sb-Form input[type='submit'].sb-Btn--block{display:block;width:100%;text-align:center}.sb-Btn--mr,a.sb-Btn--mr{margin-right:1rem}@media (max-width: 43.6875em){.sb-Btn--responsive,a.sb-Btn--responsive,.sb-Form input[type='submit'].sb-Btn--responsive{display:block;width:100%;margin-right:0}}@media (max-width: 43.6875em){.sb-Btn--responsive--mb,a.sb-Btn--responsive--mb,.sb-Form input[type='submit'].sb-Btn--responsive--mb{margin-bottom:1rem}}html,body{font-size:16px;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;font-weight:normal;line-height:1.5;color:#444444}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:0.5rem;padding-top:0.5rem}h1,h2,h3{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2}h4,h5,h6{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2}h1{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:21.7728px}@media (min-width: 43.75em){h1{font-size:26.12736px}}@media (min-width: 64em){h1{font-size:31.35283px}}h2{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:18.144px}@media (min-width: 43.75em){h2{font-size:21.7728px}}@media (min-width: 64em){h2{font-size:26.12736px}}h3{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:15.12px}@media (min-width: 43.75em){h3{font-size:18.144px}}@media (min-width: 64em){h3{font-size:21.7728px}}h4{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:12.6px}@media (min-width: 43.75em){h4{font-size:15.12px}}@media (min-width: 64em){h4{font-size:18.144px}}h5{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:12.6px}@media (min-width: 43.75em){h5{font-size:15.12px}}@media (min-width: 64em){h5{font-size:15.12px}}h6{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:12.6px}@media (min-width: 43.75em){h6{font-size:12.6px}}@media (min-width: 64em){h6{font-size:12.6px}}p,dl,ul,ol{font-size:1rem;line-height:1.5}strong,b{font-weight:bold}a{text-decoration:none;color:#1e39d2;cursor:pointer}a:visited{color:#1e39d2}a:hover{color:#0e1b62}a:active{color:#1e39d2}a.is-currentPage{color:#1e39d2;cursor:text}.sb-Dialog{border-width:2px;border-style:solid;margin-bottom:1rem;border-radius:0.5rem}.sb-Dialog h1,.sb-Dialog h2,.sb-Dialog h3,.sb-Dialog h4,.sb-Dialog h5,.sb-Dialog h6{font-size:1.125rem;line-height:1.5rem;padding:0;margin:0 0 0.5rem}.sb-Dialog ul{padding-left:1em;text-indent:-1em;list-style-position:inside}.sb-Dialog-icon{width:1.5rem;font-size:1.5rem;line-height:1.5rem;display:table-cell;vertical-align:top;padding:0.75rem}.sb-Dialog-message{display:table-cell;vertical-align:top;padding-top:0.75rem;padding-right:1rem}.sb-Dialog--error{border-top-width:10px;border-color:#b80000}.sb-Dialog--error h1,.sb-Dialog--error h2,.sb-Dialog--error h3,.sb-Dialog--error h4,.sb-Dialog--error h5,.sb-Dialog--error h6{color:#b80000}.sb-Dialog--error .sb-Icon--error:before{content:'ð¨';font-style:normal}.sb-Dialog--info{border-color:#1e39d2}.sb-Dialog--info .sb-Icon--info:before{content:'â¹ï¸';font-style:normal}.sb-Dialog--success{border-color:#23b268}.sb-Dialog--success .sb-Icon--success:before{content:'â';font-style:normal}.sb-Dialog--warning{border-color:#de8f00}.sb-Dialog--warning .sb-Icon--warning:before{content:'â ï¸';font-style:normal}@font-face{font-family:"SharpSans";font-style:normal;font-weight:100;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:italic;font-weight:100;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:normal;font-weight:normal;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:italic;font-weight:normal;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:normal;font-weight:bold;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:italic;font-weight:bold;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:normal;font-weight:700;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:italic;font-weight:700;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.woff) format("woff")}pre{margin-bottom:1rem}@font-face{font-family:"fontello";font-weight:normal;font-style:normal;src:url(/assets/fontello-5c6d5a4b860bc986924a1ec510dcddbc10a425672dc0e3ba37e3bd4020e9d84f.eot);src:url(/assets/fontello-5c6d5a4b860bc986924a1ec510dcddbc10a425672dc0e3ba37e3bd4020e9d84f.eot#iefix) format("embedded-opentype"),url(/assets/fontello-a11118120d4b90a4c4f937c40ed47f13b4ae131b1c6371fd85ec2843d7bc7b12.woff) format("woff"),url(/assets/fontello-813519383401ebf865d03b706d20d1624b232501f0accdfa1bff4d28265d3f74.ttf) format("truetype"),url(/assets/fontello-f25b435813c4882a6189f926bc10b0fc872c358e3071d21d8386765518bc4278.svg#fontello) format("svg")}[class^="icon-"]:before,[class*=" icon-"]:before{font-family:"fontello";font-style:normal;font-weight:normal;speak:none;display:inline-block;text-decoration:inherit;width:1em;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em}.icon-home:before{content:'\e800'}.icon-twitter:before{content:'\e801'}.icon-git:before{content:'\e802'}p>code,ul>code,ol>code,li>code,dl>code,td>code{background-color:#f7f7f7;font-size:90%;padding:2px 3px}.highlight>pre{background-color:#f7f7f7;padding:0.5rem 1rem;border-radius:3px;margin-bottom:1rem}.highlight{background:#ffffff}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#ffdddd}.highlight .gd .x{color:#000000;background-color:#ffaaaa}.highlight .ge{font-style:italic}.highlight .gr{color:#aa0000}.highlight .gh{color:#999999}.highlight .gi{color:#000000;background-color:#ddffdd}.highlight .gi .x{color:#000000;background-color:#aaffaa}.highlight .go{color:#888888}.highlight .gp{color:#555555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaaaaa}.highlight .gt{color:#aa0000}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#009999}.highlight .s{color:#d14}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#008080}.highlight .ni{color:#800080}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nn{color:#555555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{font-weight:bold}.highlight .w{color:#bbbbbb}.highlight .mf{color:#009999}.highlight .mh{color:#009999}.highlight .mi{color:#009999}.highlight .mo{color:#009999}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#009999}.tb-Default{display:-webkit-box;display:-moz-box;display:box;display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-moz-box-orient:vertical;box-orient:vertical;-webkit-box-direction:normal;-moz-box-direction:normal;box-direction:normal;-webkit-flex-direction:column;-moz-flex-direction:column;flex-direction:column;-ms-flex-direction:column;min-height:100vh}.tb-Default-main{max-width:100%;margin-left:auto;margin-right:auto;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;-webkit-flex:1;-moz-flex:1;-ms-flex:1;flex:1}.tb-Default-main:after{content:" ";display:block;clear:both}.tb-Default-content{width:100%;float:left;margin-left:0;margin-right:0}.tb-Home{display:-webkit-box;display:-moz-box;display:box;display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-moz-box-orient:vertical;box-orient:vertical;-webkit-box-direction:normal;-moz-box-direction:normal;box-direction:normal;-webkit-flex-direction:column;-moz-flex-direction:column;flex-direction:column;-ms-flex-direction:column;min-height:100vh}.tb-Home-main{max-width:100%;margin-left:auto;margin-right:auto;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;-webkit-flex:1;-moz-flex:1;-ms-flex:1;flex:1}.tb-Home-main:after{content:" ";display:block;clear:both}@media (min-width: 64em){.tb-Home-content{width:74.57627%;float:left;margin-right:1.69492%}}@media (min-width: 81.25em){.tb-Home-content{width:74.68354%;float:left;margin-right:1.26582%}}.tb-Home--author .tb-Sidebar{display:block}.tb-Post{display:-webkit-box;display:-moz-box;display:box;display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-moz-box-orient:vertical;box-orient:vertical;-webkit-box-direction:normal;-moz-box-direction:normal;box-direction:normal;-webkit-flex-direction:column;-moz-flex-direction:column;flex-direction:column;-ms-flex-direction:column;min-height:100vh}.tb-Post-main{max-width:100%;margin-left:auto;margin-right:auto;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;-webkit-flex:1;-moz-flex:1;-ms-flex:1;flex:1}.tb-Post-main:after{content:" ";display:block;clear:both}@media (min-width: 64em){.tb-Post-content{width:74.57627%;float:left;margin-right:1.69492%}}@media (min-width: 81.25em){.tb-Post-content{width:74.68354%;float:left;margin-right:1.26582%}}@media (min-width: 64em){.tb-Post-author{display:block;margin-top:1rem;width:23.72881%;float:right;margin-right:0}}@media (min-width: 81.25em){.tb-Post-author{width:24.05063%;float:right;margin-right:0}}@media (min-width: 43.75em){.tb-Post h1:first-child{width:70%}}.tb-Team{margin-top:1.5rem}.tb-Member{width:100%;float:left;margin-left:0;margin-right:0;text-align:center;padding-bottom:2rem}@media (min-width: 43.75em){.tb-Member{width:32.20339%;float:left}.tb-Member:nth-child(3n+1){margin-left:0;margin-right:-100%;clear:both;margin-left:0}.tb-Member:nth-child(3n+2){margin-left:33.89831%;margin-right:-100%;clear:none}.tb-Member:nth-child(3n+3){margin-left:67.79661%;margin-right:-100%;clear:none}}.tb-Member-gravatar img{max-width:100%;border-radius:50%}.tb-Member--posts{margin-top:0.5rem}.tb-Sidebar{display:none;padding:1rem}@media (min-width: 64em){.tb-Sidebar{display:block;width:23.72881%;float:right;margin-right:0}}@media (min-width: 81.25em){.tb-Sidebar{width:24.05063%;float:right;margin-right:0}}.tb-Author-gravatar{text-align:center}.tb-Author-gravatar img{border-radius:50%}.tb-Author-info{text-align:center}.tb-Author-icons{margin-top:0.5rem}.tb-Author-icon a,.tb-Author-icon a:visited{color:gray;padding:0.25rem;font-size:1.25rem}.tb-Author-icon a:hover{color:#5ccfc2}.tb-Author-posts{margin-top:0.5rem}.tb-Excerpt{max-width:100%;margin-left:auto;margin-right:auto;border-bottom:1px dotted #d5d5d5;padding-bottom:1rem;margin-bottom:1rem}.tb-Excerpt:after{content:" ";display:block;clear:both}.tb-Excerpt-date{margin-bottom:0.5rem;color:#939393}.tb-Header{background-color:white;background-color:rgba(255,255,255,0.95);border-bottom:1px solid #cccccc;display:block;margin-top:0.5rem;margin-bottom:1rem}.tb-Header::after{clear:both;content:"";display:table}#tb-Header-toggle{display:none;position:relative;cursor:pointer;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#tb-Header-toggle:checked+.tb-Header-area .tb-Header-menu{display:block;opacity:1;z-index:10}.tb-Header-home-link{text-decoration:none}.tb-Header-home-logo{display:block;margin-top:0.375rem}.tb-Header-home-logo img{width:85%;max-width:450.5px}.tb-Header-toggle{cursor:pointer}@media (min-width: 43.75em){.tb-Header-toggle{display:none}}.tb-Header-toggle:after{width:2.625rem;height:2.625rem;position:absolute;right:1rem;top:1rem;display:block;content:'\e800';font-family:'inkicons';font-size:2rem;color:#cccccc;cursor:pointer;text-align:center;vertical-align:center}@media (min-width: 43.75em){.tb-Header-toggle:after{display:none}}.tb-Header-menu{display:none;opacity:0;width:100%;margin:0;padding:0;position:absolute;right:0}.tb-Header-menu::after{clear:both;content:"";display:table}@media (min-width: 43.75em){.tb-Header-menu{position:inherit;display:block;opacity:1}}.tb-Header-menu:after{content:"";height:3px;width:100%;background-color:rgba(0,0,0,0.1)}@media (min-width: 43.75em){.tb-Header-menu:after{display:none}}.tb-Header-menu-item{display:block;width:100%;list-style:none}@media (min-width: 43.75em){.tb-Header-menu-item{float:left;width:auto}}.tb-Header-menu-link{padding:0.75rem 1rem;background-color:#f8f8f8;background-color:white;border-bottom:0.25rem solid transparent;border-bottom:1px solid #cccccc;color:inherit;display:block;padding-bottom:0.25rem;text-decoration:none;width:100%}@media (min-width: 43.75em){.tb-Header-menu-link{border-bottom:0.25rem solid transparent}}.tb-Header-menu-link:hover,.tb-Header-menu-link:active,.tb-Header-menu-link:visited{color:inherit}.tb-Header-menu-link:hover{border-bottom:0.25rem solid #fa3c00;color:#fa3c00}.tb-Header-menu-link.is-active{border-bottom:0.25rem solid #fa3c00;color:#fa3c00}.tb-Header-menu-link:before{content:attr(data-link-long)}@media (min-width: 43.75em){.tb-Header-menu-link:before{content:attr(data-link-short)}}@media (min-width: 64em){.tb-Header-menu-link:before{content:attr(data-link-long)}}.tb-Footer{background-color:#ededed;margin-top:2rem;padding:1rem;text-align:center;width:100%}.tb-Paginator{width:100%;float:left;margin-left:0;margin-right:0}.tb-Paginator-newerBtn{width:47.36842%;float:left;margin-right:5.26316%}@media (min-width: 43.75em){.tb-Paginator-newerBtn{width:23.72881%;float:left;margin-right:1.69492%}}.tb-Paginator-newerBtn .sb-Btn{width:100%}.tb-Paginator-olderBtn{width:47.36842%;float:right;margin-right:0}@media (min-width: 43.75em){.tb-Paginator-olderBtn{width:23.72881%;float:right;margin-right:0}}.tb-Paginator-olderBtn .sb-Btn{width:100%}.tb-AsideQuote{display:none;position:relative;width:30vw;float:right;background-color:#f7f7f7;border-radius:3px;font-family:Georgia, serif;font-size:1.25rem;line-height:1.2;color:#939393;font-style:italic;padding:1rem 1rem 1rem 3rem;margin-left:1rem;margin-bottom:1rem}.tb-AsideQuote:before{content:"\201C";font-family:Georgia, serif;font-size:3rem;font-weight:bold;color:#d5d5d5;position:absolute;left:0.75rem;top:0.5rem}@media (min-width: 43.75em){.tb-AsideQuote{display:block}}.tb-Images{max-width:100%;margin-left:auto;margin-right:auto}.tb-Images:after{content:" ";display:block;clear:both}@media (min-width: 81.25em){.tb-Img-processing{max-width:50%}}.tb-Img{max-width:100%}@media (min-width: 43.75em){.tb-Img{float:right;clear:right;margin-bottom:1rem;margin-left:1rem}}.tb-Img--fancy{border-radius:0.25rem}.tb-Img--picture{padding:0.5rem;border:1px solid #eeeeee;background-color:white;box-shadow:2px 2px 4px 0px rgba(0,0,0,0.2);margin-bottom:0 !important}@media (min-width: 43.75em){.tb-Img--quarter{max-width:25%}}@media (max-width: 43.6875em){.tb-Img--quarter--sm{max-width:25% !important;float:right;clear:right;margin-bottom:0.5rem;margin-left:0.5rem}}@media (min-width: 43.75em) and (max-width: 63.9375em){.tb-Img--quarter--md{max-width:25%}}@media (min-width: 64em) and (max-width: 81.1875em){.tb-Img--quarter--lg{max-width:25%}}@media (min-width: 43.75em){.tb-Img--third{max-width:33%}}@media (max-width: 43.6875em){.tb-Img--third--sm{max-width:33% !important;float:right;clear:right;margin-bottom:0.5rem;margin-left:0.5rem}}@media (min-width: 43.75em) and (max-width: 63.9375em){.tb-Img--third--md{max-width:33%}}@media (min-width: 64em) and (max-width: 81.1875em){.tb-Img--third--lg{max-width:33%}}@media (min-width: 43.75em){.tb-Img--half{max-width:50%}}@media (max-width: 43.6875em){.tb-Img--half--sm{max-width:50% !important;float:right;clear:right;margin-bottom:0.5rem;margin-left:0.5rem}}@media (min-width: 43.75em) and (max-width: 63.9375em){.tb-Img--half--md{max-width:50%}}@media (min-width: 64em) and (max-width: 81.1875em){.tb-Img--half--lg{max-width:50%}}@media (min-width: 43.75em){.tb-Img--responsive{max-width:50%}}@media (min-width: 64em){.tb-Img--responsive{max-width:40%}}@media (min-width: 81.25em){.tb-Img--responsive{max-width:30%}}.tb-Img--responsive-ctr{margin-bottom:1rem}@media (min-width: 43.75em){.tb-Img--responsive-ctr{float:none !important;clear:none !important;display:block;width:70%;margin-top:0 !important;margin-right:auto !important;margin-left:auto !important}}@media (min-width: 43.75em) and (min-width: 43.75em){.tb-Img--responsive-ctr{margin-bottom:1.5rem !important}}@media (min-width: 64em){.tb-Img--responsive-ctr{max-width:60%}}@media (min-width: 81.25em){.tb-Img--responsive-ctr{max-width:50%}}.tb-ImgCenter{margin:0 24%}@font-face{font-family:'tbicons';src:url(/assets/tbicons-096fa3970ce3a3595debd167e1cd11422745885e43987130c7ad2b9fd020a910.eot);src:url(/assets/tbicons-096fa3970ce3a3595debd167e1cd11422745885e43987130c7ad2b9fd020a910.eot#iefix) format("embedded-opentype"),url(/assets/tbicons-a255c4d7531756c350cd3cb8ac924a3a70dba66357bc6f53cdcce66be69e1ca4.woff) format("woff"),url(/assets/tbicons-04c88863a35923e4156691375c162cd8b6fb44104e3cecbc17972c89da722d17.ttf) format("truetype"),url(/assets/tbicons-737a98cc543fbd45788943a259ba88d32a06bdd4e57cf10d9631866dce5df09e.svg#tbicons) format("svg");font-weight:normal;font-style:normal}[class^="tb-Icon-"]:before,[class*=" tb-Icon-"]:before{font-family:"tbicons";font-style:normal;font-weight:normal;speak:none;display:inline-block;text-decoration:inherit;width:1em;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em}.tb-Icon-twitter:before{content:'\e800'}.tb-Icon-home:before{content:'\e801'}.tb-Icon-github:before{content:'\e802'}.tb-Masthead{margin-bottom:1rem}.tb-Masthead::after{clear:both;content:"";display:table}@media (min-width: 43.75em){.tb-Masthead{margin-top:1rem;margin-bottom:2rem}}.tb-Masthead .tb-Img{float:none;display:block;margin:0}.tb-Masthead aside{display:block;color:#939393;margin-top:0.25rem;font-size:10px;line-height:1rem;height:1rem;text-align:right}.tb-Masthead a{color:#939393;text-decoration:none;border:0}.tb-Masthead a:link,.tb-Masthead a:visited,.tb-Masthead a:hover,.tb-Masthead a:active{color:#939393}.tb-Masthead-caption{position:relative}.tb-Masthead-caption:after{display:block;position:absolute;top:0;right:0;content:attr(caption)}
</style>
</head>

  <body class="tb-Post">
    <header class="tb-Header">
  <div class="sb-Wrapper">
    <nav class="tb-Header-home">
      <a href="/" class="tb-Header-home-logo"><img src="/assets/CustomInk_Tech_Color-1460f9e847670e2626e66143266004749ab6c7204a8d5a2ae394613f986c473d.png"></a>
    </nav>
    <input type="checkbox" id="tb-Header-toggle" />
    <div class="tb-Header-area">
      <label for="tb-Header-toggle" class="tb-Header-toggle" data-open="Menu" data-close="Close" onclick></label>
      <ul class="tb-Header-menu">
        <li class="tb-Header-menu-item">
          <a href="/" class="tb-Header-menu-link ">POSTS</a>
        </li>
        <li class="tb-Header-menu-item">
          <a href="/team" class="tb-Header-menu-link ">AUTHORS</a>
        </li>
        <li class="tb-Header-menu-item">
          <a href="/careers" class="tb-Header-menu-link ">CAREERS</a>
        </li>
        <li class="tb-Header-menu-item">
          <a href="http://customink.com" class="tb-Header-menu-link">CUSTOMINK.COM</a>
        </li>
      </ul>
    </div>
  </div>
</header>

    <div class="tb-Post-main sb-Wrapper">
      <div class="tb-Post-content">
        <h1>Rails Multi-Database Best Practices Roundup</h1>
        <div class="sb-Dialog sb-Dialog--info">
  <div class="sb-Dialog-icon">
    <i class="sb-Icon--info"></i>
  </div>
  <div class="sb-Dialog-message">
    <h3>Seamless second database integration for Rails.</h3>
    <p>
      2016-01-11: We just finished a new version of SecondBase, our own gem that provides support for Rails to manage dual databases by extending ActiveRecord tasks that create, migrate, and test your application. It supports Rails 4.x and up. <a href="https://github.com/customink/secondbase">Check it out on GitHub.</a>
    </p>
   </div>
</div>

<p>Since landing my first job programming with Ruby, most Rails applications I have worked with have managed two or more database connections. Often times these connections are both readable and writable. Collectively they represent a comprehensive business domain. Today I would like to cover everything I know about this topic, without going into the bike shed of micro services or schema management gems.</p>

<p>The goal is simple! To give you the tools you need to keep your application running smoothly when connecting to multiple databases.</p>

<h2 id="topics-scenarios">Topics &amp; Scenarios</h2>

<p>Each topic or scenario below is tested within a demo Rails application that you can checkout on GitHub. See the <a href="#resources">resources section</a> at the bottom of this post for more information. Examples assume that Rails 3.2.x to 4.2.x are the same behavior. When this is not the case, it will be explicitly pointed out.</p>

<p>Reasons for multiple database connections vastly differ. To illustrate a common setup, this demo application will use PostgreSQL as the base &quot;legacy&quot; connection. Just imagine this base is something like Oracle or SQL Server. Our second connection is going to be MySQL. This is the database we want to migrate our primary new business logic onto.</p>

<p>To easily follow along, MySQL models will be prefixed as such and all ActiveRecord logs have been tagged with the database connection that executed the query. This setup will give us more than enough opportunity to explore and have fun. Lets go!</p>

<h3 id="topic-1-connection-management">Topic 1: Connection Management</h3>

<p>First and foremost we are going to need a base class that champions a database connection. This is critical so that each subclass shares the same connection/pool. For example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">MysqlBase</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">establish_connection</span> <span class="n">configurations</span><span class="p">[</span><span class="s1">'mysql'</span><span class="p">][</span><span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">]</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div>
<p><strong>Do not use establish_connection for other models.</strong> Only use it for the base connection class. Setting your base connection class as an <code>abstract_class</code> keeps ActiveRecord from querying the database for column information. Meaning this model has no attributes. Use this connection class as the superclass for each of your MySQL models. For example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">MysqlBase</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">MysqlBase</span>
<span class="k">end</span>
</code></pre></div>
<p>Now, each model will will share the same connection pool. Benefits include:</p>

<ul>
<li>Shared transaction blocks.</li>
<li>Reduced database connections.</li>
<li>Single point for connection management.</li>
</ul>

<h3 id="topic-2-the-activerecord-query-cache">Topic 2: The ActiveRecord Query Cache</h3>

<p>ActiveRecord&#39;s <a href="http://guides.rubyonrails.org/caching_with_rails.html#sql-caching">query cache</a> can be a beneficial performance optimization. On by default, it caches SQL results for the same query during the request/response cycle. This caching really shines with child to parent associations where <code>n</code> children find the same parent and only hit the database once.</p>

<p>Unfortunately ActiveRecord can only cache your base connection. It knows not of other databases. So let&#39;s &quot;cash in&quot; on some of our simple code dividends and put that base connection class to work.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

  <span class="n">around_filter</span> <span class="ss">:cache_other_db_connections</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">cache_other_db_connections</span>
    <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">cache</span> <span class="p">{</span> <span class="k">yield</span> <span class="p">}</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>Yup, it is that easy! If you had multiple database connections, just nest them in the outer block and yield once to the controller&#39;s around filter.</p>

<h3 id="scenario-1-implicit-multi-db-transactions">Scenario 1: Implicit Multi-DB Transactions</h3>

<p>So what happens when a model for one database creates or updates another model?</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">MysqlUser</span> <span class="o">&lt;</span> <span class="no">MysqlBase</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">table_name</span> <span class="o">=</span> <span class="ss">:users</span>
  <span class="n">after_save</span> <span class="ss">:account_create</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">account_create</span>
    <span class="no">Account</span><span class="p">.</span><span class="nf">create_from_user!</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Our <code>MysqlUser</code> model is going to save a legacy account model using the <code>after_save</code> callback. Remember, ActiveRecord runs creates or saves inside of a transaction.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">new_mysql_user</span><span class="p">.</span><span class="nf">account_create</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">new_mysql_user</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div><div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">MySQL</span><span class="p">:</span>  <span class="k">BEGIN</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`users`</span> <span class="p">(...)</span> <span class="k">VALUES</span> <span class="p">(...)</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">BEGIN</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"accounts"</span> <span class="p">(...)</span> <span class="k">VALUES</span> <span class="p">(...)</span> <span class="n">RETURNING</span> <span class="nv">"id"</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">COMMIT</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">COMMIT</span>
</code></pre></div>
<p>So the outcome is pretty clear here. We have two distinct database transactions. One is not going to affect the other. What would happen if the account raised an exception when being created? Possibly due to a validation error?</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">new_mysql_user</span><span class="p">.</span><span class="nf">account_create</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">new_mysql_user</span><span class="p">.</span><span class="nf">account_fails_validation</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">new_mysql_user</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div><div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">MySQL</span><span class="p">:</span>  <span class="k">BEGIN</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`users`</span> <span class="p">(...)</span> <span class="k">VALUES</span> <span class="p">(...)</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">BEGIN</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">ROLLBACK</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">ROLLBACK</span>
</code></pre></div>
<p>Not bad. We can see that ActiveRecord handles this simple setup quite well. Both the user and the account are rolled back.</p>

<h3 id="topic-3-the-activerecord-rollback-exception">Topic 3: The ActiveRecord::Rollback Exception</h3>

<p>With our first scenario understood, it is time for another topic. Time to talk about the <code>ActiveRecord::Rollback</code> exception object. Please take a moment to read the ActiveRecord documentation.</p>

<blockquote>
<p>Transaction uses this exception to distinguish a deliberate
rollback from other exceptional situations. Normally, raising
an exception will cause the transaction method to rollback
the database transaction and pass on the exception. But if
you raise an ActiveRecord::Rollback exception, then the database
transaction will be rolled back, without passing on the exception.</p>
</blockquote>

<p>Did you see that? Using an <code>ActiveRecord::Rollback</code> will <strong>NOT</strong> pass the exception to a higher transaction block. To illustrate what happens, let&#39;s take our last scenario example and change the account to raise an <code>ActiveRecord::Rollback</code> vs a validation exception.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">new_mysql_user</span><span class="p">.</span><span class="nf">account_create</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">new_mysql_user</span><span class="p">.</span><span class="nf">account_raise_rollback</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">new_mysql_user</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div><div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">MySQL</span><span class="p">:</span>  <span class="k">BEGIN</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`users`</span> <span class="p">(...)</span> <span class="k">VALUES</span> <span class="p">(...)</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">BEGIN</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">ROLLBACK</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">COMMIT</span>
</code></pre></div>
<p>And there we go! The MySQL user just carries along on its happy way and commits the change. I will have more rollback examples below, but I might go so far as to say that you may never want to use <code>ActiveRecord::Rollback</code> unless you have a very clear grasp on how to manage transactions.</p>

<h3 id="scenario-2-explicit-multi-db-transactions">Scenario 2: Explicit Multi-DB Transactions</h3>

<p>Implicit transactions are great for one or two model instances, but sooner are later you will need to orchestrate more objects within a larger commit. Explicit transactions give you this control. Here is a simple multi-database example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">MysqlUser</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="no">MysqlUser</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'one@one.com'</span>
  <span class="no">MysqlUser</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'two@two.com'</span>
  <span class="no">Account</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'one@one.com'</span>
  <span class="no">Account</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'two@two.com'</span>
<span class="k">end</span>
</code></pre></div><div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">MySQL</span><span class="p">:</span>  <span class="k">BEGIN</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`users`</span> <span class="p">(...)</span> <span class="k">VALUES</span> <span class="p">(...)</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`users`</span> <span class="p">(...)</span> <span class="k">VALUES</span> <span class="p">(...)</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">BEGIN</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"accounts"</span> <span class="p">(...)</span> <span class="k">VALUES</span> <span class="p">(...)</span> <span class="n">RETURNING</span> <span class="nv">"id"</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">COMMIT</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">BEGIN</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"accounts"</span> <span class="p">(...)</span> <span class="k">VALUES</span> <span class="p">(...)</span> <span class="n">RETURNING</span> <span class="nv">"id"</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">COMMIT</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">COMMIT</span>
</code></pre></div>
<p>The outer MySQL transaction was automatically joinable during the first two creates. This is because the model creates detected that the connection was already under a sharable transaction. The problem here is that the base connection had no joinable transaction block. Despite which connection we started the outer block with, the problem is the same. The solution is to open a transaction for each connection before doing any work.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">MysqlUser</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="no">Account</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
    <span class="no">MysqlUser</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'one@one.com'</span>
    <span class="no">MysqlUser</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'two@two.com'</span>
    <span class="no">Account</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'one@one.com'</span>
    <span class="no">Account</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'two@two.com'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">MySQL</span><span class="p">:</span>  <span class="k">BEGIN</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">BEGIN</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`users`</span> <span class="p">(...)</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`users`</span> <span class="p">(...)</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"accounts"</span> <span class="p">(...)</span> <span class="n">RETURNING</span> <span class="nv">"id"</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"accounts"</span> <span class="p">(...)</span> <span class="n">RETURNING</span> <span class="nv">"id"</span>
 <span class="n">Base</span><span class="p">:</span>  <span class="k">COMMIT</span>
<span class="n">MySQL</span><span class="p">:</span>  <span class="k">COMMIT</span>
</code></pre></div>
<p>Now we have a tidy atomic transaction across both databases. Any exception raised besides <code>ActiveRecord::Rollback</code> will automatically rollback both transactions. This pattern is so useful, I suggest making a helper that does the work for you. Again, this leverages the base connection class for the second database â I did promise it would come in handy.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">class_eval</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">multi_transaction</span>
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
      <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">transaction</span> <span class="p">{</span> <span class="k">yield</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">multi_transaction</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">multi_transaction</span> <span class="p">{</span> <span class="k">yield</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Now anytime you need to commit large changes, just wrap your code in <code>ActiveRecord::Base.multi_transaction { ... }</code> and sleep better knowing that your data is clean. If you want to learn more about ActiveRecord&#39;s transactions, please read the <a href="http://apidock.com/rails/ActiveRecord/ConnectionAdapters/DatabaseStatements/transaction">Rails API Docs</a>. They cover advanced topics like isolation levels and savepoints. None of which are covered in this post.</p>

<h3 id="topic-4-explicit-transactions-are-serious">Topic 4: Explicit Transactions Are Serious!</h3>

<p>If you are doing explicit transactions, you likely mean business. If so, make your code serious by using ActiveRecord&#39;s bang methods. Doing so helps keep code explicit to the task at hand with automatic rollbacks to two or more databases. Examples include:</p>

<ul>
<li><code>save!</code></li>
<li><code>create!</code></li>
<li><code>update_attributes!</code></li>
<li><code>update!</code></li>
<li><code>destroy!</code></li>
</ul>

<p>If you must raise exceptions during explicit transactions to multiple databases, please stay away from using <code>ActiveRecord::Rollback</code>, this could complicate your code and in most cases need to be re-raised.</p>

<h3 id="topic-5-shared-connection-pools">Topic 5: Shared Connection/Pools</h3>

<p>Every now and then you may use a gem whose model(s) subclasses <code>ActiveRecord::Base</code> and you want to force that connection to another database. The <code>Delayed::Job</code> library is a good example. You could use <code>establish_connection</code>, but that would generate a distinct connection pool and keep transactions from being shared. Here is a bullet proof freedom patch to use with any model.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># In config/initializers/delayed_job.rb</span>

<span class="no">Delayed</span><span class="o">::</span><span class="no">Backend</span><span class="o">::</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Job</span><span class="p">.</span><span class="nf">class_eval</span> <span class="k">do</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>

    <span class="k">def</span> <span class="nf">connection_pool</span>
      <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection_pool</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">retrieve_connection</span>
      <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">retrieve_connection</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">connected?</span>
      <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connected?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">remove_connection</span><span class="p">(</span><span class="n">klass</span> <span class="o">=</span> <span class="nb">self</span><span class="p">)</span>
      <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">remove_connection</span>
    <span class="k">end</span>

  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This would change Delayed::Job from using our base connection to using our second MySQL connection. It is best to do patches like this in a Rails initializer. This guarantees gems are already reqired and in most cases have not yet connected to the database. If your model connects before these patches are applied, you could end up with an orphaned connection pool to the wrong database.</p>

<p>The patch works by overriding critical connection specification/handling class methods defined on ActiveRecord::Base. The first two methods <code>connection_pool</code> and <code>retrieve_connection</code> will make all your queries work. The second two will ensure all remaining connection management methods like <code>remove_connection</code> and <code>clear_all_connections!</code> do the same. But remember! If you need to do any connection management, you really only need do it on the connection class, in this case, <code>MysqlBase</code>.</p>

<h3 id="topic-6-forked-processes-clearing-connections">Topic 6: Forked Processes &amp; Clearing Connections</h3>

<p>Most libraries that fork your Rails application process know how to reset ActiveRecord&#39;s base connections. This includes web servers like Passenger or Unicorn. However, it is up to you to do the same for any other database connections. This is easy to do by leveraging our connection class in the first topic.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">clear_all_connections!</span>
<span class="no">MysqlBase</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">configurations</span><span class="p">[</span><span class="s1">'mysql'</span><span class="p">][</span><span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">]</span>
</code></pre></div>
<p>First we clear all connections. This is normally done before forking. Methods like <code>clear_all_connections!</code> and <code>clear_active_connections!</code> iterate across all connection pools. You only need to call this once, not per connection. Second, we call <code>establish_connection</code> on our MySQL connection class using the same configuration method we did in the first topic.</p>

<h3 id="topic-7-rails-transactional-fixtures">Topic 7: Rails Transactional Fixtures</h3>

<p>If you are using transactional fixtures and you have fixtures for each connection, then ActiveRecord will do all the work for you by making sure each test is wrapped with transactional savepoints to each database. However, if you do not have fixtures for all connections then it is up to you to start the first transaction for each additional connection. Again, using our MySQL connection class as an example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Rails 3.2.x</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">increment_open_transactions</span>
  <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">transaction_joinable</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">begin_db_transaction</span>
<span class="k">end</span>
<span class="n">after</span> <span class="k">do</span>
  <span class="k">if</span> <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">open_transactions</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">rollback_db_transaction</span>
    <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">decrement_open_transactions</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Rails 4.2.x</span>
<span class="n">before</span> <span class="p">{</span> <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">begin_transaction</span> <span class="ss">joinable: </span><span class="kp">false</span> <span class="p">}</span>
<span class="n">after</span>  <span class="p">{</span> <span class="no">MysqlBase</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">rollback_transaction</span> <span class="p">}</span>
</code></pre></div>
<p>Please remember that ActiveRecord uses savepoints for nested transactions. Depending on your database, you will see <code>SAVEPOINT</code> and <code>RELEASE SAVEPOINT</code> for tests in your logs. Only the outer most transactions will use <code>BEGIN</code> and <code>ROLLBACK</code>.</p>

<h2 id="resources">Resources</h2>

<p>Thanks for reading this far. Did I miss anything important or maybe you would like to ask a question? If so, drop a comment and I would be more than happy to expand on any topic.</p>

<p>Each topic or scenario here is fully tested in a demo rails application. Check it out on GitHub if you are interested in playing around with these or any other multi-database topics that interest you. If you find a new one or care to share your own, please drop a comment or a pull request.</p>

<ul>
<li><a href="https://github.com/customink/encom_dbs">Tested Multi-Database Rails Application</a></li>
</ul>

      </div>
      <div class="tb-Post-author">
        
        
        <div class="tb-Author">
  
    <div class="tb-Author-gravatar">
      <img title="Ken Collins" src="https://www.gravatar.com/avatar/0a4a62376a54055b727fca8fa0442c3d?s=150"/>
    </div>
  
  <div class="tb-Author-info">
    
      <time pubdate datetime="2015-06-22T00:00:00-04:00">
        22 Jun 2015
      </time></br>
      by Ken Collins
    
    <div class="tb-Author-icons">
      
        <span class="tb-Author-icon">
          <a href="https://twitter.com/metaskills"><i class="tb-Icon-twitter"></i></a>
        </span>
      
      
        <span class="tb-Author-icon">
          <a href="https://github.com/metaskills"><i class="tb-Icon-github"></i></a>
        </span>
      
      
        <span class="tb-Author-icon">
          <a href="http://metaskills.net/"><i class="tb-Icon-home"></i></a>
        </span>
      
    </div>
    
      <div class="tb-Author-posts">
        <a href="/authors/ken-collins" class="sb-Btn sb-Btn--secondary sb-Btn--small">
          View All Posts
        </a>
      </div>
    
  </div>
</div>

      </div>
    </div>
    
  <div class="sb-Wrapper">
    <section id="disqus_thread">
    </section>
  </div>
  <script type="text/javascript">
    var disqus_shortname = 'custominktechnologyblog';
    var disqus_identifier = '/blog/2015/06/22/rails-multi-database-best-practices-roundup/';
    var disqus_title = "Rails Multi-Database Best Practices Roundup";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


    <div class="tb-Footer">
  <div><small>&copy; 2020 CustomInk, LLC. All rights reserved.</small></div>
  <div><small><a href="https://customink.com">CustomInk</a> is a registered trademark of CustomInk LLC. "T-shirts Unite!" and the "Inky" octopus are trademarks of CustomInk, LLC.</small></div>
</div>

    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32456448-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


    <script async src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </body>
</html>
