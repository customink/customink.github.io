<!DOCTYPE html>
<html>
  <head>
  <title>Migrating Session Flash from Rails 3.0.x to 3.2.x - CustomInk Technology Blog</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="When upgrading a high-traffic Rails application from 3.0.x to 3.2.x, existing
sessions with Flash data will raise dump format error during the sess...">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://technology.customink.com/feed.xml" />
  <link rel="stylesheet" href="/assets/app-b651f92cdaf3b55ddcf369818f306fa8.css">
  <script type="text/javascript">
  (function(d) {
    var config = {
      kitId: 'tph7yyf',
      scriptTimeout: 3000
    },
    h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='//use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
</script>

  
</head>

  <body class="tb-Post">
    <header class="tb-Header">
  <div class="sb-Wrapper">
    <nav class="tb-Header-home">
      <a href="/" class="tb-Header-home-logo"><img src="/assets/CustomInk_Tech_Color-1eab0e8af4627b0a8eb96649c8ab2274.png"></a>
    </nav>
    <input type="checkbox" id="tb-Header-toggle" />
    <div class="tb-Header-area">
      <label for="tb-Header-toggle" class="tb-Header-toggle" data-open="Menu" data-close="Close" onclick></label>
      <ul class="tb-Header-menu">
        <li class="tb-Header-menu-item">
        
          <a href="/team" class="tb-Header-menu-link">TEAM</a>
        
        </li>
        <li class="tb-Header-menu-item">
          <a href="http://customink.com" class="tb-Header-menu-link">CUSTOMINK.COM</a>
        </li>
      </ul>
    </div>
  </div>
</header>

    <div class="tb-Post-main sb-Wrapper">
      <div class="tb-Post-content">
        <h1>Migrating Session Flash from Rails 3.0.x to 3.2.x</h1>
        <p>When upgrading a high-traffic Rails application from 3.0.x to 3.2.x, existing
sessions with Flash data will raise <strong>dump format error</strong> during the session unmarshalling
step of the users next request. For an ostensibly minor patch <a href="http://semver.org/">(see semver)</a>, breaking
user sessions is an unexpected surprise and a real bummer for your users.</p>

<p>The Rails breaking change to <code>FlashHash</code> was to stop inheriting from Hash:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Rails 3.0 - See: http://git.io/X8WqIw</span>
<span class="k">class</span> <span class="nc">FlashHash</span> <span class="o">&lt;</span> <span class="no">Hash</span>

<span class="c1"># Rails 3.2 - See: http://git.io/jJ_Qhw</span>
<span class="k">class</span> <span class="nc">FlashHash</span>
</code></pre></div>
<p>Dealing with serialization errors can be notoriously difficult, even more so because these were occurring deep
in the framework. So, we monkey patched <code>ActiveRecord::SessionStore::Session</code> to remove the offending Flash data.
The possible loss was a notification displayed on the page, the benefit was maintaining user sessions across the
upgrade deployment.</p>

<p>If we catch the <strong>dump format error</strong>, assume it&#39;s the Flash and delete it, the remainder of the session
may be unmarshalled and accessed.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">SessionStore</span><span class="o">::</span><span class="no">Session</span><span class="p">.</span><span class="nf">class_eval</span> <span class="k">do</span>

 <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">unmarshal</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
   <span class="k">return</span> <span class="k">unless</span> <span class="n">data</span>

   <span class="n">marshalled</span> <span class="o">=</span> <span class="kp">nil</span>
   <span class="k">begin</span>
     <span class="n">decoded</span> <span class="o">=</span> <span class="o">::</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span> <span class="n">data</span>
     <span class="n">marshalled</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span> <span class="n">decoded</span>
   <span class="k">rescue</span> <span class="no">ArgumentError</span> <span class="o">=&gt;</span> <span class="n">ae</span>
     <span class="k">if</span> <span class="n">ae</span><span class="p">.</span><span class="nf">message</span> <span class="o">=~</span> <span class="sr">/dump format error/</span>
       <span class="n">with_alternate_flash_klass</span> <span class="k">do</span>
         <span class="n">marshalled</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span> <span class="n">decoded</span>
         <span class="n">marshalled</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s1">'flash'</span><span class="p">)</span>
       <span class="k">end</span>
     <span class="k">else</span>
       <span class="k">raise</span> <span class="n">ae</span>
     <span class="k">end</span>
   <span class="k">end</span>

   <span class="n">marshalled</span>
 <span class="k">end</span>

 <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre></div>
<p>We start by monkey patching the <code>ActiveRecord::SessionStore::Session#unmarshal</code> method to rescue
<code>ArgumentError</code>. <a href="https://github.com/rails/rails/blob/3-2-stable/activerecord/lib/active_record/session_store.rb#L59-L61">see original method</a></p>

<p>If the <code>ArgumentError</code> message is <strong>dump format error</strong>, we use a back-ported <code>FlashHash</code> implementation and attempt to decode again. This
time we delete the &#39;flash&#39; data and return the unmarshalled session. Going forward, the session should be valid because new Flash data will
be from the current <code>FlashHash</code> object.</p>

<p>In the monkey patched <code>ActiveRecord::SessionStore::Session#unmarshal</code> above, you&#39;ll notice the <code>with_alternate_flash_klass</code> block
for the second attempt to unmarshal. This method takes the block to execute and handles the redefining of the <code>FlashHash</code> constant for you. It
conveniently restores the <code>FlashHash</code> after the unmarshalling.</p>

<p>First, we create helper method to dynamically create the alternate <code>FlashHash</code> class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">alternate_flash_klass</span>
  <span class="k">if</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="o">::</span><span class="no">FlashHash</span><span class="p">.</span><span class="nf">ancestors</span><span class="p">.</span><span class="nf">include?</span> <span class="no">Hash</span>
    <span class="no">Class</span><span class="p">.</span><span class="nf">new</span><span class="p">()</span> <span class="k">do</span> <span class="c1">#rails3.2 FlashHash</span>
      <span class="k">def</span> <span class="nf">initialize</span>
        <span class="vi">@used</span>    <span class="o">=</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span>
        <span class="vi">@closed</span>  <span class="o">=</span> <span class="kp">false</span>
        <span class="vi">@flashes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="vi">@now</span>     <span class="o">=</span> <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="no">Class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="k">do</span> <span class="c1">#rails3.0 FlashHash</span>
      <span class="k">def</span> <span class="nf">initialize</span>
        <span class="k">super</span>
        <span class="vi">@used</span> <span class="o">=</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Using <code>Class.new()</code>, we have the option of passing in a parent, which we do for the rails 3.0 version.</p>

<p>Next, we need a method to swap the <code>FlashHash</code> and execute a block:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">with_alternate_flash_klass</span>
  <span class="n">temporary_flash_hash_klass</span> <span class="o">=</span> <span class="n">alternate_flash_klass</span>

  <span class="n">original_flash_hash_klass</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="o">::</span><span class="no">FlashHash</span>
  <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="p">.</span><span class="nf">send</span> <span class="ss">:remove_const</span><span class="p">,</span> <span class="ss">:FlashHash</span>
  <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="p">.</span><span class="nf">const_set</span> <span class="s1">'FlashHash'</span><span class="p">,</span> <span class="n">temporary_flash_hash_klass</span>

  <span class="k">yield</span>

  <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="p">.</span><span class="nf">send</span> <span class="ss">:remove_const</span><span class="p">,</span> <span class="ss">:FlashHash</span>
  <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="p">.</span><span class="nf">const_set</span> <span class="s1">'FlashHash'</span><span class="p">,</span> <span class="n">original_flash_hash_klass</span>
<span class="k">end</span>
</code></pre></div>
<p>This saves the current <code>FlashHash</code> in <code>original_flash_hash_klass</code>, redefines the constant. When the block
is yielded, the unmarshal is attempted with the back-ported <code>FlashHash</code>. Then we restore the original <code>FlashHash</code>.</p>

<p>Astute readers, will notice <code>alternate_flash_klass</code> will provide a back-port or forward-port implementation of <code>FlashHash</code>.
This allows us to deploy Rails 3.2 and rollback to Rails 3.0. If you deployed Rails 3.2, allowed some sessions to be
persisted, then rolled back, those sessions would be corrupt. This implementation supports going forward and backward
with only a loss of Flash notifications.</p>

<h3 id="config/initializers/rails32_session_upgrade_patches.rb">config/initializers/rails32_session_upgrade_patches.rb</h3>

<p>You can add this code to an initialization file. You may only need it for 30 days or until your sessions expire. We
have a <strong>warn</strong> so your reminded this monkey patch is still present in your code.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># ActionDispatch::Flash::FlashHash changed between 3.0 and 3.2</span>
<span class="c1"># Rails 3.0.x FlashHash inherits from Hash, this was removed in Rails 3.2.x</span>
<span class="c1"># if a session was created in 3.0.x, after deploy we would receive</span>
<span class="c1"># 'dump format error' when trying to deserialize the session</span>
<span class="c1">#</span>
<span class="c1"># this monkey patch attempts to unmarshal with an alternate version</span>
<span class="c1"># of FlashHash and deletes it if successful</span>
<span class="c1">#</span>
<span class="nb">warn</span> <span class="s2">"[TEMPORARY] Loading session monkey patches for Rails 3.0.x =&gt; 3.2.x upgrade"</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">SessionStore</span><span class="o">::</span><span class="no">Session</span><span class="p">.</span><span class="nf">class_eval</span> <span class="k">do</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">unmarshal</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="n">data</span>

    <span class="n">marshalled</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="k">begin</span>
      <span class="n">decoded</span> <span class="o">=</span> <span class="o">::</span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span> <span class="n">data</span>
      <span class="n">marshalled</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span> <span class="n">decoded</span>
    <span class="k">rescue</span> <span class="no">ArgumentError</span> <span class="o">=&gt;</span> <span class="n">ae</span>
      <span class="k">if</span> <span class="n">ae</span><span class="p">.</span><span class="nf">message</span> <span class="o">=~</span> <span class="sr">/dump format error/</span>
        <span class="n">with_alternate_flash_klass</span> <span class="k">do</span>
          <span class="n">marshalled</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span> <span class="n">decoded</span>
          <span class="n">marshalled</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s1">'flash'</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">else</span>
        <span class="k">raise</span> <span class="n">ae</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">marshalled</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">alternate_flash_klass</span>
    <span class="k">if</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="o">::</span><span class="no">FlashHash</span><span class="p">.</span><span class="nf">ancestors</span><span class="p">.</span><span class="nf">include?</span> <span class="no">Hash</span>
      <span class="no">Class</span><span class="p">.</span><span class="nf">new</span><span class="p">()</span> <span class="k">do</span> <span class="c1">#rails3.2 FlashHash</span>
        <span class="k">def</span> <span class="nf">initialize</span>
          <span class="vi">@used</span>    <span class="o">=</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span>
          <span class="vi">@closed</span>  <span class="o">=</span> <span class="kp">false</span>
          <span class="vi">@flashes</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="vi">@now</span>     <span class="o">=</span> <span class="kp">nil</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="no">Class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="k">do</span> <span class="c1">#rails3.0 FlashHash</span>
        <span class="k">def</span> <span class="nf">initialize</span>
          <span class="k">super</span>
          <span class="vi">@used</span> <span class="o">=</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">with_alternate_flash_klass</span>
    <span class="n">temporary_flash_hash_klass</span> <span class="o">=</span> <span class="n">alternate_flash_klass</span>

    <span class="n">original_flash_hash_klass</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="o">::</span><span class="no">FlashHash</span>
    <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="p">.</span><span class="nf">send</span> <span class="ss">:remove_const</span><span class="p">,</span> <span class="ss">:FlashHash</span>
    <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="p">.</span><span class="nf">const_set</span> <span class="s1">'FlashHash'</span><span class="p">,</span> <span class="n">temporary_flash_hash_klass</span>

    <span class="k">yield</span>

    <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="p">.</span><span class="nf">send</span> <span class="ss">:remove_const</span><span class="p">,</span> <span class="ss">:FlashHash</span>
    <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Flash</span><span class="p">.</span><span class="nf">const_set</span> <span class="s1">'FlashHash'</span><span class="p">,</span> <span class="n">original_flash_hash_klass</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="bonus!-tests">Bonus! Tests</h3>

<p><strong>NOTE</strong> you will need to copy session from your application for these
tests to pass. The session data below is invalid.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">Rails32SessionUpgradePatchesTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s1">'remove flash from rails 3.0.x sessions in rails 3.2.x'</span> <span class="k">do</span>
    <span class="n">rails30_session</span> <span class="o">=</span> <span class="s1">'7CUkiDnByb2R1Y3RpZAY6BkVGSSIKMDExMDQGOwBUSSIMbGFiX3VybAY7
    AEYiNGh0dHA6Ly93d3cuY3VzdG6taW5rLmNvbS9sYWI/Y2lkPWNobTAtMDAx
    akxVVlYyOWVxVHRPQk9ES1NCNFliVjVWUT0GOwBGSSIKZmxhc2gGOwBGSUM6
    JUFjdGlvbkRpc3BhdGNoOjpGbGFzaDo6Rmxhc2hIYXNoewY6CmVycm9yewc6
    IGluZm9ybWF0aW9uLgY7AEY6DG1lc3NhZ2VJIiZQbGVhc2UgZmlsbCBpbiBh
    IHJlY2lwaWVudCBiZWxvdy4GOwBGBjoKQHVzZWRvOghTZXQGOgpAaGFzaHsG
    OwdU'</span>

    <span class="n">session</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">SessionStore</span><span class="o">::</span><span class="no">Session</span><span class="p">.</span><span class="nf">unmarshal</span> <span class="n">rails30_session</span>
    <span class="n">assert_nil</span> <span class="n">session</span><span class="p">[</span><span class="s1">'flash'</span><span class="p">]</span>
  <span class="k">end</span> <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">version</span> <span class="o">=~</span> <span class="sr">/^3\.2/</span>

  <span class="nb">test</span> <span class="s1">'remove flash from rails 3.2.x sessions in rails 3.0.x'</span> <span class="k">do</span>
    <span class="n">rails32_session</span> <span class="o">=</span> <span class="s1">'7BkkiCmZsYXNoBjoGRUZvOiVBY3Rpb25EaXNwYXRjaDo6Rmxhc2g6OkZs
    YXNoSGFzaAk6CkB1c2VkbzoIU2V0BjoKQGhhc2h7BjoJd2FyblQ6DEBjbG9z
    ZWRGOg1AZmxhc2hlc3sGOwp7BjoMbWVzc2FnZUkiAcJQbGVhc2Ugbm90ZSB0
    dHdvcmsgYmVmb3JlIHByb2NlZWRpbmcgd2l0aCBwcm9kdWN0aW9uLiBQbGVh
    bWVudCB3aXRoIGEgbGluayB0byB5b3VyIGZpbmFsIHBpY3R1cmUgcHJvb2Zz
    LgY7AEY6CUBub3dvOiRBY3Rpb25EaXNwYXRjaDo6Rmxhc2g6OkZsYXNoTm93
    BjoLQGZsYXNoQAc='</span>

    <span class="n">session</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">SessionStore</span><span class="o">::</span><span class="no">Session</span><span class="p">.</span><span class="nf">unmarshal</span> <span class="n">rails32_session</span>
    <span class="n">assert_nil</span> <span class="n">session</span><span class="p">[</span><span class="s1">'flash'</span><span class="p">]</span>
  <span class="k">end</span> <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">version</span> <span class="o">=~</span> <span class="sr">/^3\.0/</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="pretty?">Pretty?</h3>

<p>No, it&#39;s not pretty. But it will help you overcome an unexpected <strong>dump format error</strong> when deploying
a Rails 3.2 upgrade.</p>

      </div>
      <div class="tb-Author">
  
    <div class="tb-Author-gravatar">
      <img title="Chris Mar" src="http://www.gravatar.com/avatar/7c9f4c37280d4cf26f9bda785478a09a?s=150"/>
    </div>
  

  <div class="tb-Author-info">
    <time pubdate datetime="2014-09-23T00:00:00-04:00">
      23 Sep 2014
    </time></br>
    by Chris Mar
  </div>
</div>

    </div>

    <section id="disqus_thread">
  test
</section>

<script type="text/javascript">
  var disqus_shortname = 'custominktechnologyblog';
  var disqus_identifier = '/blog/2014/09/23/migrating-session-flash-from-rails-30x-to-32x';
  var disqus_title = "Migrating Session Flash from Rails 3.0.x to 3.2.x";
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


    <div class="tb-Footer">
  <div><small>&copy; 2014 CustomInk, LLC. All rights reserved.</small></div>
  <div><small><a href="http://customink.com">CustomInk</a> is a registered trademark of CustomInk LLC. "T-shirts Unite!" and the "Inky" octopus are trademarks of CustomInk, LLC.</small></div>
</div>

    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32456448-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


    <script src="/assets/app-ca69057f0a3c7907fba6689b1396c0dd.js"></script>
  </body>
</html>
