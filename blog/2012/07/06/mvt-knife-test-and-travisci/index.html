<!DOCTYPE html>
<html>
  <head>
  <title>MVT: knife test and TravisCI - CustomInk Technology Blog</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="In my last post, MVT: Foodcritic and Travis CI I described the process for having Travis CI look after your cookbooks and run Foodcritic, the cookb...">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://technology.customink.com/feed.xml" />
  <link rel="stylesheet" href="/assets/app-1193f26ffafc82796d02d27f7d8607d4.css">
  <script type="text/javascript">
  (function(d) {
    var config = {
      kitId: 'tph7yyf',
      scriptTimeout: 3000
    },
    h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='//use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
</script>

  
</head>

  <body class="tb-Post">
    <header class="tb-Header">
  <div class="sb-Wrapper">
    <nav class="tb-Header-home">
      <a href="/" class="tb-Header-home-logo"><img src="/assets/CustomInk_Tech_Color-f9e81e9def04cfa2ba39d06ee8e218e4.png"></a>
    </nav>
    <input type="checkbox" id="tb-Header-toggle" />
    <div class="tb-Header-area">
      <label for="tb-Header-toggle" class="tb-Header-toggle" data-open="Menu" data-close="Close" onclick></label>
      <ul class="tb-Header-menu">
        <li class="tb-Header-menu-item">
        
          <a href="/team" class="tb-Header-menu-link">AUTHORS</a>
        
        </li>
        <li class="tb-Header-menu-item">
          <a href="http://customink.com" class="tb-Header-menu-link">CUSTOMINK.COM</a>
        </li>
      </ul>
    </div>
  </div>
</header>

    <div class="tb-Post-main sb-Wrapper">
      <div class="tb-Post-content">
        <h1>MVT: knife test and TravisCI</h1>
        <p>In my last post, <a href="/blog/2012/06/04/mvt-foodcritic-and-travis-ci/">MVT: Foodcritic and Travis CI</a> I described the process for having Travis CI look after your cookbooks and run Foodcritic, the cookbook lint tool, on your cookbook after each <code>git push</code>.  In this post, we&#39;ll iterate on the &quot;Minimum Viable Test&quot; idea by adding in support for knife&#39;s cookbook testing.</p>

<p>Wait, I&#39;m already running foodcritic, do I really need to run <code>knife cookbook test</code>, too?</p>

<p>I&#39;ll use a very simple example to demonstrate that you do.</p>

<p>Let&#39;s create a very basic cookbook:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">knife cookbook create very_basic
<span class="k">**</span> Creating cookbook very_basic
<span class="k">**</span> Creating README <span class="k">for </span>cookbook: very_basic
<span class="k">**</span> Creating metadata <span class="k">for </span>cookbook: very_basic
</code></pre></div>
<p>Next, we&#39;ll write a flawed recipe:</p>

<p>``` ruby cookbooks/very_basic/recipes/default.rb
package &quot;flawed&quot; do
  action :nothing
end
end</p>
<div class="highlight"><pre><code class="language-" data-lang="">
Now, run foodcritic on this cookbook:

``` sh
foodcritic cookbooks/very_basic
</code></pre></div>
<p>Foodcritic doesn&#39;t throw any errors or find any problem with the cookbook.</p>

<p>Let&#39;s try testing it with knife:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">knife cookbook <span class="nb">test </span>very_basic
checking very_basic
Running syntax check on very_basic
Validating ruby files
FATAL: Cookbook file recipes/default.rb has a ruby syntax error:
FATAL: /Users/nharvey/projects/chef-hosted/.chef/../cookbooks/very_basic/recipes/default.rb:22: syntax error, unexpected keyword_end, expecting <span class="nv">$end</span>
</code></pre></div>
<p>OK, it should now be obvious that <code>knife cookbook test</code> should be included as part of our MVT.</p>

<!-- more -->

<p>To get Travis CI running <code>knife cookbook test</code> for us, we&#39;ll need to add or update the following files:</p>

<ul>
<li>.travis.yml</li>
<li>Rakefile</li>
<li>test/.chef/knife.rb</li>
<li>test/support/Gemfile</li>
</ul>

<p>Of course, this assumes you&#39;ve configured your cookbook as described in the <a href="/blog/2012/06/04/mvt-foodcritic-and-travis-ci/">previous post</a>.  Let&#39;s start with the Rakefile.</p>

<p>``` ruby Rakefile</p>

<h1 id="usr-bin-env-rake">!/usr/bin/env rake</h1>

<p>desc &quot;Runs knife cookbook test&quot;
task :knife do
  Rake::Task[:prepare_sandbox].execute</p>

<p>sh &quot;bundle exec knife cookbook test cookbook -c test/.chef/knife.rb -o #{sandbox_path}/../&quot;
end</p>

<p>task :prepare_sandbox do
  files = %w{*.md *.rb attributes definitions files libraries providers recipes resources templates}</p>

<p>rm_rf sandbox_path
  mkdir_p sandbox_path
   cp_r Dir.glob(&quot;{#{files.join(&#39;,&#39;)}}&quot;), sandbox_path
end</p>

<p>private
def sandbox_path
  File.join(File.dirname(<strong>FILE</strong>), %w(tmp cookbooks cookbook))
end</p>
<div class="highlight"><pre><code class="language-" data-lang="">
In the file snippet above, I've only included the parts that are relevant for getting knife working.  I'll include the full source of the Rakefile at the end of the article.

Next, let's add this rake task to our .travis.yml file.

``` ruby .travis.yml
language: ruby
gemfile:
   - test/support/Gemfile
rvm:
  - 1.9.2
  - 1.9.3
script:
  - bundle exec rake knife
</code></pre></div>
<p>To successfully run the knife command, Travis CI will need a very minimal Chef configuration.</p>

<p>``` ruby test/.chef/knife.rb
cache_type &#39;BasicFile&#39;
cache_options(:path =&gt; &quot;#{ENV[&#39;HOME&#39;]}/.chef/checksums&quot;)</p>
<div class="highlight"><pre><code class="language-" data-lang="">
And, of course, we'll need to add Chef to our Gemfile.  Be sure to specify a modern version as Travis CI will use 0.8.10 by default (at the time of this writing).

``` ruby test/support/Gemfile
source "https://rubygems.org"

gem 'rake'
gem 'chef', '~&gt; 10.12.0'
</code></pre></div>
<p>That&#39;s it.  On your next <code>git push</code> Travis CI should run <code>knife cookbook test</code> on your cookbook.</p>

<h2 id="running-locally">Running locally</h2>

<p>To run the rake tasks locally, you&#39;ll need to tell bundler where the Gemfile is, or you&#39;ll need to move it to the root directory of your cookbook and update .travis.yml appropriately.  Use the following command to run your tests locally:</p>

<p><code>BUNDLE_GEMFILE=test/support/Gemfile rake knife</code>
<code>BUNDLE_GEMFILE=test/support/Gemfile rake foodcritic</code></p>

<h2 id="full-source-code">Full source code</h2>

<p>You can checkout this <a href="https://github.com/customink-webops/percona-install/compare/03b9446...d423b14">Github compare view</a> to see the changes made to the code from the <a href="/blog/2012/06/04/mvt-foodcritic-and-travis-ci/">previous post</a>.</p>

<p>``` ruby test/.chef/knife.rb
cache_type &#39;BasicFile&#39;
cache_options(:path =&gt; &quot;#{ENV[&#39;HOME&#39;]}/.chef/checksums&quot;)</p>
<div class="highlight"><pre><code class="language-" data-lang="">
``` ruby .travis.yml
language: ruby
gemfile:
   - test/support/Gemfile
rvm:
  - 1.9.2
  - 1.9.3
script:
  - bundle exec rake knife
  - bundle exec rake foodcritic
</code></pre></div>
<p>The Rakefile was refactored a bit since the previous post:</p>

<p>``` ruby Rakefile</p>

<h1 id="usr-bin-env-rake">!/usr/bin/env rake</h1>

<p>task :default =&gt; &#39;foodcritic&#39;</p>

<p>desc &quot;Runs foodcritic linter&quot;
task :foodcritic do
  Rake::Task[:prepare_sandbox].execute</p>

<p>if Gem::Version.new(&quot;1.9.2&quot;) &lt;= Gem::Version.new(RUBY_VERSION.dup)
    sh &quot;foodcritic -f any #{sandbox_path}&quot;
  else
    puts &quot;WARN: foodcritic run is skipped as Ruby #{RUBY_VERSION} is &lt; 1.9.2.&quot;
  end
end</p>

<p>desc &quot;Runs knife cookbook test&quot;
task :knife do
  Rake::Task[:prepare_sandbox].execute</p>

<p>sh &quot;bundle exec knife cookbook test cookbook -c test/.chef/knife.rb -o #{sandbox_path}/../&quot;
end</p>

<p>task :prepare_sandbox do
  files = %w{*.md *.rb attributes definitions files libraries providers recipes resources templates}</p>

<p>rm_rf sandbox_path
  mkdir_p sandbox_path
  cp_r Dir.glob(&quot;{#{files.join(&#39;,&#39;)}}&quot;), sandbox_path
end</p>

<p>private
def sandbox_path
  File.join(File.dirname(<strong>FILE</strong>), %w(tmp cookbooks cookbook))
end</p>
<div class="highlight"><pre><code class="language-" data-lang="">
``` ruby test/support/Gemfile
source "https://rubygems.org"

gem 'rake'
gem 'foodcritic'
gem 'chef', '~&gt; 10.12.0'
</code></pre></div>
<h3 id="credit">Credit</h3>

<p>A big &quot;Thank You!&quot; shout-out to <a href="/blog/our-team/seth-vargo.html">Seth Vargo</a> for writing most of the code used in this post!</p>

<hr>

<p><sub>Reposted from <a href="http://nathenharvey.com/blog/2012/07/06/mvt-knife-test-and-travisci/">Nathen Harvey&#39;s blog</a><sub></p>

      </div>
      

<div class="tb-Author">
  
  <div class="tb-Author-info">
    <time pubdate datetime="2012-07-06T22:52:00-04:00">
      06 Jul 2012
    </time></br>
    by Nathen Harvery
    <div class="tb-Author-icons">
      
      
      
    </div>
  </div>
</div>

    </div>

    
  <div class="sb-Wrapper">
    <section id="disqus_thread">
    </section>
  </div>
  <script type="text/javascript">
    var disqus_shortname = 'custominktechnologyblog';
    var disqus_identifier = '/blog/2012/07/06/mvt-knife-test-and-travisci/';
    var disqus_title = "MVT: knife test and TravisCI";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


    <div class="tb-Footer">
  <div><small>&copy; 2016 CustomInk, LLC. All rights reserved.</small></div>
  <div><small><a href="http://customink.com">CustomInk</a> is a registered trademark of CustomInk LLC. "T-shirts Unite!" and the "Inky" octopus are trademarks of CustomInk, LLC.</small></div>
</div>

    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32456448-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


    <script src="/assets/app-c8c0da21cd353ed58196e02e376670a3.js"></script>
  </body>
</html>
