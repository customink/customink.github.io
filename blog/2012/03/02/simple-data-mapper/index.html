<!DOCTYPE html>
<html>
  <head>
  <title>Simple Data Mapper - CustomInk Technology Blog</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="Simple Data Mapper


  
    02 Mar 2012
    by Karle Durante
  
  
    
      
    
  



  I recently tackled a pretty typical data migration task...">
  <link rel="stylesheet" href="/assets/app-1194ecb864aba9ff3f0df0c1cfb23fa5.css">
  <script type="text/javascript">
  (function(d) {
    var config = {
      kitId: 'tph7yyf',
      scriptTimeout: 3000
    },
    h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='//use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
</script>

</head>

  <body class="Default">
    <header class="tb-Header">
  <div class="sb-Wrapper">
    <nav class="tb-Header-home">
      <a href="/" class="tb-Header-home-logo"><img src="/assets/CustomInk_Tech_Color-1eab0e8af4627b0a8eb96649c8ab2274.png"></a>
    </nav>
    <input type="checkbox" id="tb-Header-toggle" />
    <div class="tb-Header-area">
      <label for="tb-Header-toggle" class="tb-Header-toggle" data-open="Menu" data-close="Close" onclick></label>
      <ul class="tb-Header-menu">
        <li class="tb-Header-menu-item">
        
          <a href="/team" class="tb-Header-menu-link">TEAM</a>
        


        </li>
        <li class="tb-Header-menu-item">
          <a href="http://customink.com" class="tb-Header-menu-link">CUSTOMINK.COM</a>
        </li>
      </ul>
    </div>
  </div>
</header>

    <div class="main sb-Wrapper">
      <div class="content">
        <h1>Simple Data Mapper</h1>

<div class="author">
  <div class="info">
    02 Mar 2012<br>
    by Karle Durante
  </div>
  <div class="gravatar">
    
      <img width="40px" src="http://www.gravatar.com/avatar/41e75ca920386f6949e2f9cc1714d71f?s=150"/>
    
  </div>
</div>

<div class="post">
  <p>I recently tackled a pretty typical data migration task where some source model had to be transformed into some target model.  About 80% of the elements were mapped field for field, and the other 20% had to be mutated in some way.  Tired of writing one off rake tasks to pull and transform data, I came up with a little data mapper class that I cold reuse in the future.</p>

<!--more-->
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Mapper</span>
  <span class="kp">attr_accessor</span> <span class="ss">:source_model</span>
  <span class="kp">attr_accessor</span> <span class="ss">:mappings</span>

  <span class="k">class</span> <span class="nc">AttributeMapping</span><span class="p">;</span><span class="k">end</span>

  <span class="k">class</span> <span class="nc">ListMapping</span> <span class="o">&lt;</span> <span class="no">AttributeMapping</span>
    <span class="kp">attr_accessor</span> <span class="ss">:fields</span>

    <span class="c1"># fields - array of field symbols we want to map data into</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">fields</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">source_obj</span><span class="p">,</span> <span class="n">source_attribute</span><span class="p">)</span>
      <span class="p">{}.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">values</span><span class="o">|</span>
        <span class="n">fields</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">field</span><span class="o">|</span>
          <span class="n">values</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_obj</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">source_attribute</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">ComplexMapping</span> <span class="o">&lt;</span> <span class="no">AttributeMapping</span>
    <span class="kp">attr_accessor</span> <span class="ss">:field</span>
    <span class="kp">attr_accessor</span> <span class="ss">:instruction</span>

    <span class="c1"># field       - field symbol we want to map data into</span>
    <span class="c1"># instruction - lambda which accepts source object and source attribute.</span>
    <span class="c1">#               expected to return value to be mapped to field (on target obj)</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">instruction</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">field</span> <span class="o">=</span> <span class="n">field</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">instruction</span> <span class="o">=</span> <span class="n">instruction</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">source_obj</span><span class="p">,</span> <span class="n">source_attribute</span><span class="p">)</span>
      <span class="p">{</span> <span class="n">field</span> <span class="o">=&gt;</span> <span class="n">instruction</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">source_obj</span><span class="p">,</span> <span class="n">source_attribute</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="n">mappings</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">source_model</span> <span class="o">=</span> <span class="n">source_model</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">mappings</span> <span class="o">=</span> <span class="n">mappings</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">conjure</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">map_values_for</span><span class="p">(</span> <span class="nb">self</span><span class="p">.</span><span class="nf">source_model</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="nf">mappings</span> <span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">camelize</span><span class="p">.</span><span class="nf">constantize</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">map_values_for</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="n">mappings</span><span class="p">)</span>
    <span class="p">{}.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">values</span><span class="o">|</span>
      <span class="n">mappings</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="kp">attr</span><span class="p">,</span> <span class="n">mapping</span><span class="o">|</span>
        <span class="k">if</span> <span class="no">AttributeMapping</span> <span class="o">===</span> <span class="n">mapping</span>
          <span class="n">values</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">mapping</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="kp">attr</span><span class="p">))</span>
        <span class="k">else</span>
          <span class="n">values</span><span class="p">[</span><span class="n">mapping</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_model</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="kp">attr</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<!-- more -->

<p>Using the mapper is really simple.  Let&#39;s say my source model, LegacyCustomer, is based off of a legacy table from an older system and looks like:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">LegacyCustomer</span><span class="p">(</span>
  <span class="ss">userid: </span><span class="n">integer</span><span class="p">,</span>        <span class="c1"># primary key</span>
  <span class="ss">creationdate: </span><span class="n">datetime</span><span class="p">,</span> <span class="c1"># date record was created</span>
  <span class="ss">accountnum: </span><span class="n">string</span>      <span class="c1"># customer number. it's prefixed with</span>
                          <span class="c1"># "LGCY-" string that we no longer need!</span>
<span class="p">)</span>
</code></pre></div>
<p>And we want to migrate the LegacyCustomer data to a new Customer model that looks like:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Customer</span><span class="p">(</span>
  <span class="ss">id: </span><span class="n">integer</span><span class="p">,</span>
  <span class="ss">created_at: </span><span class="n">datetime</span><span class="p">,</span>
  <span class="ss">updated_at: </span><span class="n">datetime</span><span class="p">,</span>
  <span class="ss">account_number: </span><span class="n">string</span>
<span class="p">)</span>
</code></pre></div>
<p>My rake task to run the migration would look like:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">namespace</span> <span class="ss">:migrate</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:legacy_customers</span> <span class="k">do</span>
    <span class="n">field_mappings</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:userid</span>         <span class="o">=&gt;</span> <span class="ss">:id</span><span class="p">,</span>
      <span class="ss">:creation_date</span>  <span class="o">=&gt;</span> <span class="no">Mapper</span><span class="o">::</span><span class="no">ListMapping</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
                          <span class="p">[</span><span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:update_at</span><span class="p">]</span>
                         <span class="p">),</span>
      <span class="ss">:user_data</span>      <span class="o">=&gt;</span> <span class="no">Mapper</span><span class="o">::</span><span class="no">ComplexMapping</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
                          <span class="ss">:account_number</span><span class="p">,</span>
                          <span class="nb">lambda</span> <span class="p">{</span><span class="o">|</span><span class="n">obj</span><span class="p">,</span> <span class="kp">attr</span><span class="o">|</span> <span class="n">obj</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="kp">attr</span><span class="p">).</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'LGCY-'</span><span class="p">,</span><span class="s1">''</span><span class="p">)}</span>
                         <span class="p">)</span>
    <span class="p">}</span>

    <span class="no">LegacyCustomer</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">legacy_customer</span><span class="o">|</span>
      <span class="n">mapper</span> <span class="o">=</span> <span class="no">Mapper</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">legacy_customer</span><span class="p">,</span> <span class="n">field_mappings</span><span class="p">)</span>
      <span class="n">customer</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">.</span><span class="nf">conjure</span><span class="p">(</span><span class="ss">:customer</span><span class="p">)</span>
      <span class="n">customer</span><span class="p">.</span><span class="nf">save!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>As my migration marched on &#39;one off&#39; data errors would pop up causing the script to fail.  This is what ultimately led me to create the ComplexMapping class.  Every time some white space, funny character, or field split requirement bombed my script I was able to add some code to my ComplexMapping requirement to solve it.</p>

<p>I wanted to share this experience for two reasons:</p>

<p>Ruby is awesome.  Metaprogramming and Procs made this mapper possible.  When I first started programming with Ruby, these were the two hardest concepts for me to wrap my head around.  Investing time into learning these aspects of ruby have made me such a better ruby programmer.</p>

<p>The second reason is to reinforce the lesson that doing things the lazy (comfortable) way will rarely ever benefit you.  This mapper class not only made writing and maintaining my migration script easier.  It has also found it&#39;s way into some production code.</p>

<p>Abstracting concepts (or remembering the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility principle</a>) will always benefit you in the future.</p>

</div>


<section id="disqus_thread">
</section>
<script type="text/javascript">
  var disqus_shortname = 'custominktechnologyblog';
  var disqus_identifier = '/blog/2012/03/02/simple-data-mapper';
  var disqus_title = "Simple Data Mapper";
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



      </div>
    </div>
    <div class="footer">
  <div><small>&copy; 2014 CustomInk, LLC. All rights reserved.</small></div>
  <div><small><a href="http://customink.com">CustomInk</a> is a registered trademark of CustomInk LLC. "T-shirts Unite!" and the "Inky" octopus are trademarks of CustomInk, LLC.</small></div>
</div>

    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32456448-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


    <script src="/assets/app-ca69057f0a3c7907fba6689b1396c0dd.js"></script>
  </body>
</html>
