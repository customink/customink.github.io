<!DOCTYPE html>
<html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Custom Ink's Kubernetes Journey - CustomInk Technology Blog</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="There's been an elephant in the room during the past few Custom Ink Tech Blog updates. Perhaps it's been alluded to, but we've been con...">
  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://technology.customink.com/feed.xml">
  <style rel="stylesheet" type="text/css">ï»¿/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace, monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:0.35em 0.75em 0.625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}html{box-sizing:border-box}*,*::before,*::after{box-sizing:inherit}html,body{height:100%}body,button,input,select,textarea,pre{margin:0;background-color:white}h1,h2,h3,h4,h5,h6,p,dl,ol,ul{margin-top:0;margin-bottom:1rem}ol,ul{padding-left:2rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0;padding-left:1rem}button{border:0}button,input,select,textarea{font-family:inherit;font-size:100%}textarea{display:block}article,aside,details,figcaption,figure,footer,header,main,nav,section,summary{display:block}.sb-Wrapper{padding-right:1rem;padding-left:1rem}@media only screen and (min-device-width: 700px){.sb-Wrapper{width:42.75rem;margin-right:auto;margin-left:auto}}@media only screen and (min-device-width: 1024px){.sb-Wrapper{width:63rem;margin-right:auto;margin-left:auto}}@media only screen and (min-device-width: 1300px){.sb-Wrapper{width:80.25rem;margin-right:auto;margin-left:auto}}.sb-Wrapper--fluid{padding-right:1rem;padding-left:1rem;margin-right:auto;margin-left:auto}.sb-PageWrapper.is-open:before{content:'';display:block;position:absolute;top:0;right:0;bottom:0;left:0;z-index:99999999}.sb-Main{max-width:100%;margin-left:auto;margin-right:auto}.sb-Main:after{content:" ";display:block;clear:both}.sb-Main--content{padding-top:1rem}@media (min-width: 64em){.sb-Main--content{padding-top:1.5rem}}@media (max-width: 43.6875em){html.is-minimalUI{overflow:hidden}html.is-minimalUI .sb-PageWrapper{height:100%;overflow-y:scroll;-webkit-overflow-scrolling:touch}}.sb-Btn,a.sb-Btn,.sb-Btn--primary,a.sb-Btn--primary,.sb-Btn--primaryAlt,a.sb-Btn--primaryAlt,.sb-Form input[type='submit'],.sb-Form input[type='submit'].sb-Btn--primary,.sb-Form input[type='submit'].sb-Btn--primaryAlt{user-select:none;background:#1f51cf;padding:0.65rem 2rem;color:#fff;border-radius:6px;transition:all 0.1s ease-in-out;display:inline-block;text-align:center;position:relative;border:0}.sb-Btn:after,a.sb-Btn:after,.sb-Btn--primary:after,a.sb-Btn--primary:after,.sb-Btn--primaryAlt:after,a.sb-Btn--primaryAlt:after,.sb-Form input[type='submit']:after,.sb-Form input[type='submit'].sb-Btn--primary:after,.sb-Form input[type='submit'].sb-Btn--primaryAlt:after{content:"";position:absolute;width:100%;height:10px;border-radius:6px;bottom:0;left:0;box-shadow:0 -3px 0 rgba(0,0,0,0.6) inset}.sb-Btn:visited,a.sb-Btn:visited,.sb-Btn--primary:visited,a.sb-Btn--primary:visited,.sb-Btn--primaryAlt:visited,a.sb-Btn--primaryAlt:visited,.sb-Form input[type='submit']:visited,.sb-Form input[type='submit'].sb-Btn--primary:visited,.sb-Form input[type='submit'].sb-Btn--primaryAlt:visited{color:#fff}.sb-Btn:hover,a.sb-Btn:hover,.sb-Btn--primary:hover,a.sb-Btn--primary:hover,.sb-Btn--primaryAlt:hover,a.sb-Btn--primaryAlt:hover,.sb-Form input[type='submit']:hover,.sb-Form input[type='submit'].sb-Btn--primary:hover,.sb-Form input[type='submit'].sb-Btn--primaryAlt:hover{color:#fff;background:#1840a3}.sb-Btn:active,.sb-Btn:focus,.sb-Btn.is-Active,a.sb-Btn:active,a.sb-Btn:focus,a.sb-Btn.is-Active,.sb-Btn--primary:active,.sb-Btn--primary:focus,.sb-Btn--primary.is-Active,a.sb-Btn--primary:active,a.sb-Btn--primary:focus,a.sb-Btn--primary.is-Active,.sb-Btn--primaryAlt:active,.sb-Btn--primaryAlt:focus,.sb-Btn--primaryAlt.is-Active,a.sb-Btn--primaryAlt:active,a.sb-Btn--primaryAlt:focus,a.sb-Btn--primaryAlt.is-Active,.sb-Form input[type='submit']:active,.sb-Form input[type='submit']:focus,.sb-Form input[type='submit'].is-Active,.sb-Form input[type='submit'].sb-Btn--primary:active,.sb-Form input[type='submit'].sb-Btn--primary:focus,.sb-Form input[type='submit'].sb-Btn--primary.is-Active,.sb-Form input[type='submit'].sb-Btn--primaryAlt:active,.sb-Form input[type='submit'].sb-Btn--primaryAlt:focus,.sb-Form input[type='submit'].sb-Btn--primaryAlt.is-Active{outline:none;color:#fff;background:#295cdf}.sb-Btn:disabled,.sb-Btn.is-Disabled,a.sb-Btn:disabled,a.sb-Btn.is-Disabled,.sb-Btn--primary:disabled,.sb-Btn--primary.is-Disabled,a.sb-Btn--primary:disabled,a.sb-Btn--primary.is-Disabled,.sb-Btn--primaryAlt:disabled,.sb-Btn--primaryAlt.is-Disabled,a.sb-Btn--primaryAlt:disabled,a.sb-Btn--primaryAlt.is-Disabled,.sb-Form input[type='submit']:disabled,.sb-Form input[type='submit'].is-Disabled,.sb-Form input[type='submit'].sb-Btn--primary:disabled,.sb-Form input[type='submit'].sb-Btn--primary.is-Disabled,.sb-Form input[type='submit'].sb-Btn--primaryAlt:disabled,.sb-Form input[type='submit'].sb-Btn--primaryAlt.is-Disabled{opacity:.3;cursor:not-allowed;pointer-events:none}.sb-Btn--primaryRed,a.sb-Btn--primaryRed,.sb-Form input[type='submit'].sb-Btn--primaryRed{background-color:#fa3c00;transition:all 0.1s ease-in-out}.sb-Btn--primaryRed:active,.sb-Btn--primaryRed:focus,.sb-Btn--primaryRed.is-Active,a.sb-Btn--primaryRed:active,a.sb-Btn--primaryRed:focus,a.sb-Btn--primaryRed.is-Active,.sb-Form input[type='submit'].sb-Btn--primaryRed:active,.sb-Form input[type='submit'].sb-Btn--primaryRed:focus,.sb-Form input[type='submit'].sb-Btn--primaryRed.is-Active{outline:none;color:#fff;background-color:#ff602e !important}.sb-Btn--primaryRed:hover,a.sb-Btn--primaryRed:hover,.sb-Form input[type='submit'].sb-Btn--primaryRed:hover{background:#e13600}.sb-Btn--secondary,a.sb-Btn--secondary,.sb-Form input[type='submit'].sb-Btn--secondary,.sb-Btn--secondaryAlt,a.sb-Btn--secondaryAlt,.sb-Form input[type='submit'].sb-Btn--secondaryAlt{user-select:none;box-shadow:inset 0px 0px 0px 2px #1f51cf;background:transparent;padding:0.65rem 2rem;color:#1f51cf !important;transition:all 0.1s ease-in-out;display:inline-block;text-align:center}.sb-Btn--secondary:after,a.sb-Btn--secondary:after,.sb-Form input[type='submit'].sb-Btn--secondary:after,.sb-Btn--secondaryAlt:after,a.sb-Btn--secondaryAlt:after,.sb-Form input[type='submit'].sb-Btn--secondaryAlt:after{display:none}.sb-Btn--secondary:hover,.sb-Btn--secondary:focus,.sb-Btn--secondary:active,a.sb-Btn--secondary:hover,a.sb-Btn--secondary:focus,a.sb-Btn--secondary:active,.sb-Form input[type='submit'].sb-Btn--secondary:hover,.sb-Form input[type='submit'].sb-Btn--secondary:focus,.sb-Form input[type='submit'].sb-Btn--secondary:active,.sb-Btn--secondaryAlt:hover,.sb-Btn--secondaryAlt:focus,.sb-Btn--secondaryAlt:active,a.sb-Btn--secondaryAlt:hover,a.sb-Btn--secondaryAlt:focus,a.sb-Btn--secondaryAlt:active,.sb-Form input[type='submit'].sb-Btn--secondaryAlt:hover,.sb-Form input[type='submit'].sb-Btn--secondaryAlt:focus,.sb-Form input[type='submit'].sb-Btn--secondaryAlt:active{background-color:#1f51cf;color:#fff !important}.sb-Btn--secondary--white,a.sb-Btn--secondary--white,.sb-Form input[type='submit'].sb-Btn--secondary--white,.sb-Btn--secondaryAlt--white,a.sb-Btn--secondaryAlt--white,.sb-Form input[type='submit'].sb-Btn--secondaryAlt--white{background-color:#fff}.sb-Btn--link,a.sb-Btn--link,.sb-Form input[type='submit'].sb-Btn--link{border:0;background:transparent;color:#1e39d2 !important;box-shadow:none;transition:all 0.1s ease-in-out}.sb-Btn--link:after,a.sb-Btn--link:after,.sb-Form input[type='submit'].sb-Btn--link:after{display:none}.sb-Btn--link:hover,.sb-Btn--link:focus,.sb-Btn--link:active,a.sb-Btn--link:hover,a.sb-Btn--link:focus,a.sb-Btn--link:active,.sb-Form input[type='submit'].sb-Btn--link:hover,.sb-Form input[type='submit'].sb-Btn--link:focus,.sb-Form input[type='submit'].sb-Btn--link:active{background:transparent;transform:none;box-shadow:none;color:#14278f !important}.sb-Btn--linkAlt,a.sb-Btn--linkAlt,.sb-Form input[type='submit'].sb-Btn--linkAlt{border:2px solid #ededed;box-shadow:none;background-color:#ededed;color:#444 !important;transition:all 0.1s ease-in-out}.sb-Btn--linkAlt:after,a.sb-Btn--linkAlt:after,.sb-Form input[type='submit'].sb-Btn--linkAlt:after{display:none}.sb-Btn--linkAlt:hover,.sb-Btn--linkAlt:focus,.sb-Btn--linkAlt:active,a.sb-Btn--linkAlt:hover,a.sb-Btn--linkAlt:focus,a.sb-Btn--linkAlt:active,.sb-Form input[type='submit'].sb-Btn--linkAlt:hover,.sb-Form input[type='submit'].sb-Btn--linkAlt:focus,.sb-Form input[type='submit'].sb-Btn--linkAlt:active{border-color:#d4d4d4;transform:none;box-shadow:none;color:#444;background:#d4d4d4}.sb-Btn--large,a.sb-Btn--large,.sb-Form input[type='submit'].sb-Btn--large{font-size:1.25rem;font-weight:bold;padding-left:2rem;padding-right:2rem}.sb-Btn--small,a.sb-Btn--small,.sb-Form input[type='submit'].sb-Btn--small{font-size:0.85rem;padding:0.35rem 1.2rem 0.5rem}.sb-Btn--block,a.sb-Btn--block,.sb-Form input[type='submit'].sb-Btn--block{display:block;width:100%;text-align:center}.sb-Btn--mr,a.sb-Btn--mr{margin-right:1rem}@media (max-width: 43.6875em){.sb-Btn--responsive,a.sb-Btn--responsive,.sb-Form input[type='submit'].sb-Btn--responsive{display:block;width:100%;margin-right:0}}@media (max-width: 43.6875em){.sb-Btn--responsive--mb,a.sb-Btn--responsive--mb,.sb-Form input[type='submit'].sb-Btn--responsive--mb{margin-bottom:1rem}}html,body{font-size:16px;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;font-weight:normal;line-height:1.5;color:#444444}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:0.5rem;padding-top:0.5rem}h1,h2,h3{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2}h4,h5,h6{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2}h1{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:21.7728px}@media (min-width: 43.75em){h1{font-size:26.12736px}}@media (min-width: 64em){h1{font-size:31.35283px}}h2{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:18.144px}@media (min-width: 43.75em){h2{font-size:21.7728px}}@media (min-width: 64em){h2{font-size:26.12736px}}h3{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:15.12px}@media (min-width: 43.75em){h3{font-size:18.144px}}@media (min-width: 64em){h3{font-size:21.7728px}}h4{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:12.6px}@media (min-width: 43.75em){h4{font-size:15.12px}}@media (min-width: 64em){h4{font-size:18.144px}}h5{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:12.6px}@media (min-width: 43.75em){h5{font-size:15.12px}}@media (min-width: 64em){h5{font-size:15.12px}}h6{color:#444444;font-weight:bold;font-family:SharpSans, Helvetica, Arial, "Trebuchet MS", sans-serif;line-height:1.2;font-size:12.6px}@media (min-width: 43.75em){h6{font-size:12.6px}}@media (min-width: 64em){h6{font-size:12.6px}}p,dl,ul,ol{font-size:1rem;line-height:1.5}strong,b{font-weight:bold}a{text-decoration:none;color:#1e39d2;cursor:pointer}a:visited{color:#1e39d2}a:hover{color:#0e1b62}a:active{color:#1e39d2}a.is-currentPage{color:#1e39d2;cursor:text}.sb-Dialog{border-width:2px;border-style:solid;margin-bottom:1rem;border-radius:0.5rem}.sb-Dialog h1,.sb-Dialog h2,.sb-Dialog h3,.sb-Dialog h4,.sb-Dialog h5,.sb-Dialog h6{font-size:1.125rem;line-height:1.5rem;padding:0;margin:0 0 0.5rem 0}.sb-Dialog ul{padding-left:1em;text-indent:-1em;list-style-position:inside}.sb-Dialog-icon{width:1.5rem;font-size:1.5rem;line-height:1.5rem;display:table-cell;vertical-align:top;padding:0.75rem 0.75rem 0.75rem 0.75rem}.sb-Dialog-message{display:table-cell;vertical-align:top;padding-top:0.75rem;padding-right:1rem}.sb-Dialog--error{border-top-width:10px;border-color:#b80000}.sb-Dialog--error h1,.sb-Dialog--error h2,.sb-Dialog--error h3,.sb-Dialog--error h4,.sb-Dialog--error h5,.sb-Dialog--error h6{color:#b80000}.sb-Dialog--error .sb-Icon--error:before{content:'ðŸš¨';font-style:normal}.sb-Dialog--info{border-color:#1e39d2}.sb-Dialog--info .sb-Icon--info:before{content:'â„¹ï¸';font-style:normal}.sb-Dialog--success{border-color:#23b268}.sb-Dialog--success .sb-Icon--success:before{content:'âœ…';font-style:normal}.sb-Dialog--warning{border-color:#de8f00}.sb-Dialog--warning .sb-Icon--warning:before{content:'âš ï¸';font-style:normal}@font-face{font-family:"SharpSans";font-style:normal;font-weight:100;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:italic;font-weight:100;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:normal;font-weight:normal;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Medium-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:italic;font-weight:normal;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-MediumItalic-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:normal;font-weight:bold;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:italic;font-weight:bold;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:normal;font-weight:700;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-Bold-0000000000000000000000000000000000000001.woff) format("woff")}@font-face{font-family:"SharpSans";font-style:italic;font-weight:700;font-display:swap;src:url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.eot?#iefix) format("embedded-opentype"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.woff2) format("woff2"),url(https://www.customink.com/assets-inkpress/style_bitz/SharpSans-BoldItalic-0000000000000000000000000000000000000001.woff) format("woff")}pre{margin-bottom:1rem}@font-face{font-family:"fontello";font-weight:normal;font-style:normal;src:url(/assets/fontello-5c6d5a4b860bc986924a1ec510dcddbc10a425672dc0e3ba37e3bd4020e9d84f.eot);src:url(/assets/fontello-5c6d5a4b860bc986924a1ec510dcddbc10a425672dc0e3ba37e3bd4020e9d84f.eot#iefix) format("embedded-opentype"),url(/assets/fontello-a11118120d4b90a4c4f937c40ed47f13b4ae131b1c6371fd85ec2843d7bc7b12.woff) format("woff"),url(/assets/fontello-813519383401ebf865d03b706d20d1624b232501f0accdfa1bff4d28265d3f74.ttf) format("truetype"),url(/assets/fontello-f25b435813c4882a6189f926bc10b0fc872c358e3071d21d8386765518bc4278.svg#fontello) format("svg")}[class^="icon-"]:before,[class*=" icon-"]:before{font-family:"fontello";font-style:normal;font-weight:normal;speak:none;display:inline-block;text-decoration:inherit;width:1em;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em}.icon-home:before{content:'\e800'}.icon-twitter:before{content:'\e801'}.icon-git:before{content:'\e802'}p>code,ul>code,ol>code,li>code,dl>code,td>code{background-color:#f7f7f7;font-size:90%;padding:2px 3px}.highlight>pre{background-color:#f7f7f7;padding:0.5rem 1rem;border-radius:3px;margin-bottom:1rem}.highlight{background:#ffffff}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#ffdddd}.highlight .gd .x{color:#000000;background-color:#ffaaaa}.highlight .ge{font-style:italic}.highlight .gr{color:#aa0000}.highlight .gh{color:#999999}.highlight .gi{color:#000000;background-color:#ddffdd}.highlight .gi .x{color:#000000;background-color:#aaffaa}.highlight .go{color:#888888}.highlight .gp{color:#555555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaaaaa}.highlight .gt{color:#aa0000}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#009999}.highlight .s{color:#d14}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#008080}.highlight .ni{color:#800080}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nn{color:#555555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{font-weight:bold}.highlight .w{color:#bbbbbb}.highlight .mf{color:#009999}.highlight .mh{color:#009999}.highlight .mi{color:#009999}.highlight .mo{color:#009999}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#009999}.tb-Default{display:flex;flex-direction:column;min-height:100vh}.tb-Default-main{max-width:100%;margin-left:auto;margin-right:auto;flex:1}.tb-Default-main:after{content:" ";display:block;clear:both}.tb-Default-content{width:100%;float:left;margin-left:0;margin-right:0}.tb-Home{display:flex;flex-direction:column;min-height:100vh}.tb-Home-main{max-width:100%;margin-left:auto;margin-right:auto;flex:1}.tb-Home-main:after{content:" ";display:block;clear:both}@media (min-width: 64em){.tb-Home-content{width:74.57627%;float:left;margin-right:1.69492%}}@media (min-width: 81.25em){.tb-Home-content{width:74.68354%;float:left;margin-right:1.26582%}}.tb-Home--author .tb-Sidebar{display:block}.tb-Post{display:flex;flex-direction:column;min-height:100vh}.tb-Post-main{max-width:100%;margin-left:auto;margin-right:auto;flex:1}.tb-Post-main:after{content:" ";display:block;clear:both}@media (min-width: 64em){.tb-Post-content{width:74.57627%;float:left;margin-right:1.69492%}}@media (min-width: 81.25em){.tb-Post-content{width:74.68354%;float:left;margin-right:1.26582%}}.tb-Post-content .mermaid{margin-left:9em;width:50%}@media (min-width: 64em){.tb-Post-author{display:block;margin-top:1rem;width:23.72881%;float:right;margin-right:0}}@media (min-width: 81.25em){.tb-Post-author{width:24.05063%;float:right;margin-right:0}}@media (min-width: 43.75em){.tb-Post h1:first-child{width:70%}}.tb-Team{margin-top:1.5rem}.tb-Member{width:100%;float:left;margin-left:0;margin-right:0;text-align:center;padding-bottom:2rem}@media (min-width: 43.75em){.tb-Member{width:32.20339%;float:left}.tb-Member:nth-child(3n+1){margin-left:0;margin-right:-100%;clear:both;margin-left:0}.tb-Member:nth-child(3n+2){margin-left:33.89831%;margin-right:-100%;clear:none}.tb-Member:nth-child(3n+3){margin-left:67.79661%;margin-right:-100%;clear:none}}.tb-Member-gravatar img{max-width:100%;border-radius:50%}.tb-Member--posts{margin-top:0.5rem}.tb-Sidebar{display:none;padding:1rem}@media (min-width: 64em){.tb-Sidebar{display:block;width:23.72881%;float:right;margin-right:0}}@media (min-width: 81.25em){.tb-Sidebar{width:24.05063%;float:right;margin-right:0}}.tb-Author-gravatar{text-align:center}.tb-Author-gravatar img{border-radius:50%}.tb-Author-info{text-align:center}.tb-Author-serverlesshero{text-align:center}.tb-Author-serverlesshero img{width:125px;margin-top:0.5rem;margin-bottom:0;text-align:center}.tb-Author-icons{margin-top:0.5rem}.tb-Author-icon a,.tb-Author-icon a:visited{color:gray;padding:0.25rem;font-size:1.25rem}.tb-Author-icon a:hover{color:#5ccfc2}.tb-Author-posts{margin-top:0.5rem}.tb-Excerpt{max-width:100%;margin-left:auto;margin-right:auto;border-bottom:1px dotted #d5d5d5;padding-bottom:1rem;margin-bottom:1rem}.tb-Excerpt:after{content:" ";display:block;clear:both}.tb-Excerpt-date{margin-bottom:0.5rem;color:#939393}.tb-Header{background-color:white;background-color:rgba(255,255,255,0.95);border-bottom:1px solid #cccccc;display:block;margin-top:0.5rem;margin-bottom:1rem}.tb-Header::after{clear:both;content:"";display:table}#tb-Header-toggle{display:none;position:relative;cursor:pointer;-webkit-touch-callout:none;user-select:none}#tb-Header-toggle:checked+.tb-Header-area .tb-Header-menu{display:block;opacity:1;z-index:10}.tb-Header-home-link{text-decoration:none}.tb-Header-home-logo{display:block;margin-top:0.375rem}.tb-Header-home-logo img{width:85%;max-width:450.5px}.tb-Header-toggle{cursor:pointer}@media (min-width: 43.75em){.tb-Header-toggle{display:none}}.tb-Header-toggle:after{width:2.625rem;height:2.625rem;position:absolute;right:1rem;top:1rem;display:block;content:'\e800';font-family:'inkicons';font-size:2rem;color:#cccccc;cursor:pointer;text-align:center;vertical-align:center}@media (min-width: 43.75em){.tb-Header-toggle:after{display:none}}.tb-Header-menu{display:none;opacity:0;width:100%;margin:0;padding:0;position:absolute;right:0}.tb-Header-menu::after{clear:both;content:"";display:table}@media (min-width: 43.75em){.tb-Header-menu{position:inherit;display:block;opacity:1}}.tb-Header-menu:after{content:"";height:3px;width:100%;background-color:rgba(0,0,0,0.1)}@media (min-width: 43.75em){.tb-Header-menu:after{display:none}}.tb-Header-menu-item{display:block;width:100%;list-style:none}@media (min-width: 43.75em){.tb-Header-menu-item{float:left;width:auto}}.tb-Header-menu-link{padding:0.75rem 1rem;background-color:white;border-bottom:1px solid #cccccc;color:inherit;display:block;padding-bottom:0.25rem;text-decoration:none;width:100%}@media (min-width: 43.75em){.tb-Header-menu-link{border-bottom:0.25rem solid transparent}}.tb-Header-menu-link:hover,.tb-Header-menu-link:active,.tb-Header-menu-link:visited{color:inherit}.tb-Header-menu-link:hover{border-bottom:0.25rem solid #fa3c00;color:#fa3c00}.tb-Header-menu-link.is-active{border-bottom:0.25rem solid #fa3c00;color:#fa3c00}.tb-Header-menu-link:before{content:attr(data-link-long)}@media (min-width: 43.75em){.tb-Header-menu-link:before{content:attr(data-link-short)}}@media (min-width: 64em){.tb-Header-menu-link:before{content:attr(data-link-long)}}.tb-Footer{background-color:#ededed;margin-top:2rem;padding:1rem;text-align:center;width:100%}.tb-Paginator{width:100%;float:left;margin-left:0;margin-right:0}.tb-Paginator-newerBtn{width:47.36842%;float:left;margin-right:5.26316%}@media (min-width: 43.75em){.tb-Paginator-newerBtn{width:23.72881%;float:left;margin-right:1.69492%}}.tb-Paginator-newerBtn .sb-Btn{width:100%}.tb-Paginator-olderBtn{width:47.36842%;float:right;margin-right:0}@media (min-width: 43.75em){.tb-Paginator-olderBtn{width:23.72881%;float:right;margin-right:0}}.tb-Paginator-olderBtn .sb-Btn{width:100%}.tb-AsideQuote{display:none;position:relative;width:30vw;float:right;background-color:#f7f7f7;border-radius:3px;font-family:Georgia, serif;font-size:1.25rem;line-height:1.2;color:#939393;font-style:italic;padding:1rem 1rem 1rem 3rem;margin-left:1rem;margin-bottom:1rem}.tb-AsideQuote:before{content:"\201C";font-family:Georgia, serif;font-size:3rem;font-weight:bold;color:#d5d5d5;position:absolute;left:0.75rem;top:0.5rem}@media (min-width: 43.75em){.tb-AsideQuote{display:block}}.tb-Images{max-width:100%;margin-left:auto;margin-right:auto}.tb-Images:after{content:" ";display:block;clear:both}@media (min-width: 81.25em){.tb-Img-processing{max-width:50%}}.tb-Img{max-width:100%}@media (min-width: 43.75em){.tb-Img{float:right;clear:right;margin-bottom:1rem;margin-left:1rem}}.tb-Img--fancy{border-radius:0.25rem}.tb-Img--picture{padding:0.5rem;border:1px solid #eeeeee;background-color:white;box-shadow:2px 2px 4px 0px rgba(0,0,0,0.2);margin-bottom:0 !important}@media (min-width: 43.75em){.tb-Img--quarter{max-width:25%}}@media (max-width: 43.6875em){.tb-Img--quarter--sm{max-width:25% !important;float:right;clear:right;margin-bottom:0.5rem;margin-left:0.5rem}}@media (min-width: 43.75em) and (max-width: 63.9375em){.tb-Img--quarter--md{max-width:25%}}@media (min-width: 64em) and (max-width: 81.1875em){.tb-Img--quarter--lg{max-width:25%}}@media (min-width: 43.75em){.tb-Img--third{max-width:33%}}@media (max-width: 43.6875em){.tb-Img--third--sm{max-width:33% !important;float:right;clear:right;margin-bottom:0.5rem;margin-left:0.5rem}}@media (min-width: 43.75em) and (max-width: 63.9375em){.tb-Img--third--md{max-width:33%}}@media (min-width: 64em) and (max-width: 81.1875em){.tb-Img--third--lg{max-width:33%}}@media (min-width: 43.75em){.tb-Img--half{max-width:50%}}@media (max-width: 43.6875em){.tb-Img--half--sm{max-width:50% !important;float:right;clear:right;margin-bottom:0.5rem;margin-left:0.5rem}}@media (min-width: 43.75em) and (max-width: 63.9375em){.tb-Img--half--md{max-width:50%}}@media (min-width: 64em) and (max-width: 81.1875em){.tb-Img--half--lg{max-width:50%}}@media (min-width: 43.75em){.tb-Img--responsive{max-width:50%}}@media (min-width: 64em){.tb-Img--responsive{max-width:40%}}@media (min-width: 81.25em){.tb-Img--responsive{max-width:30%}}.tb-Img--responsive-ctr{margin-bottom:1rem}@media (min-width: 43.75em){.tb-Img--responsive-ctr{float:none !important;clear:none !important;display:block;width:70%;margin-top:0 !important;margin-right:auto !important;margin-left:auto !important}}@media (min-width: 43.75em) and (min-width: 43.75em){.tb-Img--responsive-ctr{margin-bottom:1.5rem !important}}@media (min-width: 64em){.tb-Img--responsive-ctr{max-width:60%}}@media (min-width: 81.25em){.tb-Img--responsive-ctr{max-width:50%}}.tb-ImgCenter{margin:0 24%}@font-face{font-family:'tbicons';src:url(/assets/tbicons-096fa3970ce3a3595debd167e1cd11422745885e43987130c7ad2b9fd020a910.eot);src:url(/assets/tbicons-096fa3970ce3a3595debd167e1cd11422745885e43987130c7ad2b9fd020a910.eot#iefix) format("embedded-opentype"),url(/assets/tbicons-a255c4d7531756c350cd3cb8ac924a3a70dba66357bc6f53cdcce66be69e1ca4.woff) format("woff"),url(/assets/tbicons-04c88863a35923e4156691375c162cd8b6fb44104e3cecbc17972c89da722d17.ttf) format("truetype"),url(/assets/tbicons-737a98cc543fbd45788943a259ba88d32a06bdd4e57cf10d9631866dce5df09e.svg#tbicons) format("svg");font-weight:normal;font-style:normal}[class^="tb-Icon-"]:before,[class*=" tb-Icon-"]:before{font-family:"tbicons";font-style:normal;font-weight:normal;speak:none;display:inline-block;text-decoration:inherit;width:1em;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em}.tb-Icon-twitter:before{content:'\e800'}.tb-Icon-home:before{content:'\e801'}.tb-Icon-github:before{content:'\e802'}.tb-Masthead{margin-bottom:1rem}.tb-Masthead::after{clear:both;content:"";display:table}@media (min-width: 43.75em){.tb-Masthead{margin-top:1rem;margin-bottom:2rem}}.tb-Masthead .tb-Img{float:none;display:block;margin:0}.tb-Masthead aside{display:block;color:#939393;margin-top:0.25rem;font-size:10px;line-height:1rem;height:1rem;text-align:right}.tb-Masthead a{color:#939393;text-decoration:none;border:0}.tb-Masthead a:link,.tb-Masthead a:visited,.tb-Masthead a:hover,.tb-Masthead a:active{color:#939393}.tb-Masthead-caption{position:relative}.tb-Masthead-caption:after{display:block;position:absolute;top:0;right:0;content:attr(caption)}
</style>
</head>

  <body class="tb-Post">
    <header class="tb-Header">
  <div class="sb-Wrapper">
    <nav class="tb-Header-home">
      <a href="/" class="tb-Header-home-logo"><img src="/assets/CustomInk_Tech_Color-1460f9e847670e2626e66143266004749ab6c7204a8d5a2ae394613f986c473d.png"></a>
    </nav>
    <input type="checkbox" id="tb-Header-toggle">
    <div class="tb-Header-area">
      <label for="tb-Header-toggle" class="tb-Header-toggle" data-open="Menu" data-close="Close" onclick></label>
      <ul class="tb-Header-menu">
        <li class="tb-Header-menu-item">
          <a href="/" class="tb-Header-menu-link ">POSTS</a>
        </li>
        <li class="tb-Header-menu-item">
          <a href="/team" class="tb-Header-menu-link ">AUTHORS</a>
        </li>
        <li class="tb-Header-menu-item">
          <a href="/careers" class="tb-Header-menu-link ">CAREERS</a>
        </li>
        <li class="tb-Header-menu-item">
          <a href="http://customink.com" class="tb-Header-menu-link">CUSTOMINK.COM</a>
        </li>
      </ul>
    </div>
  </div>
</header>

    <div class="tb-Post-main sb-Wrapper">
      <div class="tb-Post-content">
        <h1>Custom Ink's Kubernetes Journey</h1>
        <p>There's been an elephant in the room during the past few Custom Ink Tech Blog updates. Perhaps it's been alluded to, but we've been consistently putting off addressing it here, simply because of its scale, as well as how many subsequent blog posts could be written wrestling with its implications. (This, of course, means we've also been putting off said subsequent blog posts, because we never got around to writing this one.)</p>

<p>So, it's time to rip off the proverbial band-aid; the majority of Custom Ink's compute workload is now running on Kubernetes, by way of Amazon EKS. (The rest is, as you might have guessed by reading this blog, on AWS Lambda.) We no longer use Chef, and we no longer use Capistrano to deploy our services and applications directly to EC2 instances. We run everything behind Customink.com without keeping track of individual servers and persistent file systems, and all app-specific infrastructure configuration - OS, libraries, packages, resources allocated, ingress - now lives in the same Git repository as a service's source code, where developers can change them as they see fit.</p>

<!--more-->

<h1 id="the-journey-begins">The Journey Begins</h1>

<p>Even before Custom Ink moved to the cloud, the pattern of persistent, stateful servers managed by Chef with code deployed by Capistrano served us well. Our infrastructure wasn't exactly ephemeral; it would take some manual action to get a new server up, get a load balancer pointed at it, and tell Chef to tell Capistrano it was ready to deploy to. Servers tended to stick around for a while (so, not ephemeral), and when it was time for an upgrade, we'd upgrade them (so, not immutable either). That said, that pattern stayed with us in the cloud, followed us to a resilient multi-AZ layout, and absolutely beats doing everything by hand.</p>

<p>In this engineer's opinion, a cultural shift within development is what motivated us to begin the journey to ephemeral and immutable infrastructure. As you might have gleaned from some <a href="https://technology.customink.com/blog/2020/01/03/migrate-your-rails-app-from-heroku-to-aws-lambda/">past</a> <a href="https://technology.customink.com/blog/2020/03/13/using-aws-sam-cookiecutter-project-templates-to-kickstart-your-ambda-projects/">blog</a> posts, Tech Inkers know a thing or two about Heroku. The venerable PaaS taught a generation of developers that, if they could generate their runtime environment and compute resources from code instead of asking a sysadmin for it, they could deliver more, and do it faster. Over the course of time, everyone arrived at the same conclusion; <em>we can do this faster, and with less work</em>.</p>

<p>It's important to note the moment in which this sea change took place. These conversations were happening at Custom Ink in late 2019. (Yes, this blog post has been marinating for quite some time.) This mean that the immutable, ephemeral platform we were already dipping our toes into - AWS Lambda - was still a little rough around the edges. We were still getting a hang of how to use lambda layers to bring in binaries we needed for some of our services (say, MySQL and Oracle connectors) into the execution environment. <a href="https://technology.customink.com/blog/2019/04/16/secure-configs-with-aws-ssm-parameter-store-and-rails-on-lambda/">Secure secret injection out of the box was not really a thing yet.</a>. Finally, keep in mind that <a href="https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/">Lambda would not support OCI images for another year.</a> It was (and still is) fertile ground for new development, but we had a backlog of existing services that needed a new home.</p>

<p>OCI images (<a href="https://github.com/opencontainers/image-spec">Docker, for the layperson</a>) and a container orchestration platform seemed to be our quickest way to lift and shift our services to an ephemeral, immutable infrastructure. Thankfully, our applications were already stateless; environment-specific configuration was handled by dotenv, which was happy to ingest values from environment variables, and everything else lived in either databases, memory caches, or S3 buckets. There were few to no persistent files to worry about. Thanks, Rails!</p>

<p>Even in 2019, there were <a href="https://www.lastweekinaws.com/blog/the-17-ways-to-run-containers-on-aws/">some</a> <a href="https://www.lastweekinaws.com/blog/17-more-ways-to-run-containers-on-aws/">options</a> for running containers in AWS. Kubernetes won because it had mindshare on the team, and because it was the most flexible. (This last part, as we will soon learn, can be a blessing or a curse.)</p>

<p>If you're curious, our first customer-facing production service hosted on Kubernetes was the international checkout component of our website, which launched in March of 2020. The web frontend of customink.com was on Kubernetes in June of 2022, and the last to make the leap was the service that handles clipart in the design lab, which moved in January of 2023.</p>

<h1 id="eks-essentials">EKS Essentials</h1>

<p>A familiar feeling to anyone who has spun up an EKS cluster: looking at the console, maybe creating a "hello world" pod and seeing it schedule somewhere, and thinking "OK, what now?".</p>

<p>Although Fargate, EKS managed node groups, and Karpenter have since come along and made things a bit easier, there's a hard line between resources managed in AWS API and resources behind the API of your Kubernetes cluster. If you want to spin up a pod, you need to connect to the control plane of your EKS cluster and ask for it. That means you have to authenticate to it first. If you want something on the internet to be able to connect to that pod, you need to figure out how to get Kubernetes to tell AWS to point an IP address (or two, or three) at a port where your pod is reachable. If you need to get secrets (say, API tokens or passwords) into the environment of your pod, it's on you to decide how to get that out of your secrets manager of choice. EKS is very hands-off in that regard, unlike other, more opinionated Kubernetes distributions. This is how we chose to instrument our Kubernetes clusters; it is not the only way to do this, and there's certainly more CRDs and daemonsets running than those we listed here, but mastering these were critical to our adoption of Kubernetes.</p>

<h2 id="aws-auth">aws-auth</h2>

<p>One nice thing EKS comes with out-of-the-box is the <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator#readme">AWS IAM Authenticator for Kubernetes</a>. It allows us to map IAM principals to users within Kubernetes. This is handy; it means we don't have to worry about giving everyone a Kubernetes identity, and instead just scope their privileges based on their IAM identity.</p>

<p>By default, the only user who is allowed to talk to the Kubernetes control plane is the IAM principal that created the cluster. Even if that principal was a role assumed by a group of people, that's less than ideal; after all, from Kubernetes' perspective, that means there's only one user, and no way to reduce the scope of that user's access (which is, of course, full admin). Thankfully, the IAM authenticator gives us one more thing; the ability to edit a ConfigMap called <code>aws-auth</code> to associate IAM principals with groups, and groups with Roles or ClusterRoles. This means we can have an IAM role called "ReadOnly" that we map to a Kubernetes role that can only do "get" actions, or an IAM role called "PowerUser" that's allowed to restart deployments - you get the picture. This is how we map external entities, such as engineers, developers, or external software that operates on the Kubernetes API, to Kubernetes RBAC. All the calling entities need to do is run or implement the <a href="https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html">AWS IAM Authenticator</a> process, which in a nutshell uses IAM credentials to call the AWS EKS API. The caller gets a temporary session token in return, which is then good for talking to the Kubernetes control plane.</p>

<div class="mermaid" style="width: 300%; margin: 0 auto; text-align: left;">
<img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5Vc2VyLT4-K0FXUyBFS1MgR2V0LVRva2VuIEFQSTogSGVyZSdzIG15IElBTSBjcmVkZW50aWFscy4gQ2FuIEkgZ2V0IGEgdG9rZW4gdG8gdGFsayB0byBLdWJlcm5ldGVzP1xuQVdTIEVLUyBHZXQtVG9rZW4gQVBJLT4-K1VzZXI6IFN1cmUsIGhlcmUncyBhIHRva2VuXG5Vc2VyLT4-K0t1YmVybmV0ZXMgQVBJOiBUaGlzIHRva2VuIHNheXMgSSdtIG1lLiBQbGVhc2UgY3JlYXRlIGEgcG9kLlxuS3ViZXJuZXRlcyBBUEktPj4rSUFNIEF1dGhlbnRpY2F0b3I6IEFyZSB0aGV5IGFsbG93ZWQgdG8gZG8gdGhhdD9cbklBTSBBdXRoZW50aWNhdG9yLT4-K2F3cy1hdXRoIGNvbmZpZ21hcDogTGV0IG1lIGNoZWNrIHRoZSBjb25maWdtYXAuXG5hd3MtYXV0aCBjb25maWdtYXAtPj4rS3ViZXJuZXRlcyBBUEk6IFllcywgdGhleSdyZSBpbiBhIGdyb3VwIHdpdGggYSByb2xlIHRoYXQgYWxsb3dzXG5LdWJlcm5ldGVzIEFQSS0-PitQb2QgQ29udHJvbGxlcjogR28gY3JlYXRlIHRoYXQgcG9kLiIsIm1lcm1haWQiOm51bGx9">
</div>

<h2 id="ingress">Ingress</h2>

<p><a href="https://technology.customink.com/blog/2020/06/11/simplifying-custominks-http-accelerator-with-aws-cloudfront-and-application-load-balancer/">As we've written before</a>, we make use of path-based routing for some (but not all) of our customer-facing applications. Thankfully, making this change on the Kubernetes side was not a problem. The Kubernetes Ingress API allows for rule-based routing, and the <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.6/">AWS Load Balancer Controller</a> allows us to implement the ingress spec by creating and controlling Application Load Balancers. We use the AWS Load Balancer to deploy a new IngressClass - let's called it the "shared ingress" - which represents a load balancer with no rules, just various ACM certificates and security settings. Each individual application then is responsible for declaring an ingress, specifying what paths and hostnames they listen on, using using the aforementioned shared ingress as the IngressClass. The AWS Load Balancer Controller sees that an Ingress is using an IngressClass it created, and adds the corresponding rules to the "shared" load balancer. This allows us to control load balancers however we want, and even share them, from within the Kubernetes API.</p>

<h2 id="external-secrets">External Secrets</h2>

<p>There are a lot of ways and places to manage secrets, but our biggest requirement is for secrets to be encrypted at rest, restricted by IAM policies, and managed somewhere other than the Kubernetes control plane. At this time, we are using SecureString parameters in AWS Systems Manager Parameter Store. The parameters are encrypted with KMS, and IAM limits the principals that can decrypt them.</p>

<p>We elected to use the <a href="https://external-secrets.io/latest/">External Secrets Operator</a> as a mechanism to turn SSM parameters into Kubernetes Secret resources. This tool provides a number of Kubernetes Custom Resource Definitions (that is, new objects for the API to use) which allow us to access external secret stores. The key objects here are SecretStore and ExternalSecret resources. The SecretStore object instructs the ESO to connect to a secrets backend of choice. An ExternalSecret object can then be created, referencing the SecretStore we created, asking for certain values to be pulled from that backend. (In our case, the SecretStore is pointed at AWS SSM.) When an ExternalSecret is created or modified, the ESO will connect to the secrets backend, retrieve the secrets, and create a Kubernetes Secret object populated with the values. We can them use this Secret as we would any other Secret or ConfigMap, mounting it on a pod's filesystem or exposing it as environment variables to our application can use the secrets.</p>

<div class="mermaid" style="width: 300%; margin: 0 auto; text-align: left;">
<img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5FeHRlcm5hbFNlY3JldC0-PitTZWNyZXRTdG9yZTogSSBuZWVkIHZhbHVlcyBmcm9tIHRoZSBzZWNyZXRzIGJhY2tlbmQuXG5TZWNyZXRTdG9yZS0-PitFeHRlcm5hbCBTZWNyZXRzIE9wZXJhdG9yOiBHbyBnZXQgdGhlIHZhbHVlcyBmcm9tIHRoZSBiYWNrZW5kLlxuRXh0ZXJuYWwgU2VjcmV0cyBPcGVyYXRvci0-PitTU00gUGFyYW1ldGVyIFN0b3JlOiBIZXJlJ3MgbXkgSUFNIGNyZWRzLCBjYW4gSSBoYXZlIHRoZXNlIHNlY3JldHM_XG5TU00gUGFyYW1ldGVyIFN0b3JlLT4-K0V4dGVybmFsIFNlY3JldHMgT3BlcmF0b3I6IEhlcmUgeW91IGdvLlxuRXh0ZXJuYWwgU2VjcmV0cyBPcGVyYXRvci0-PitTZWNyZXQ6IEknbGwgY3JlYXRlIGEgc2VjcmV0IHdpdGggdGhlIHZhbHVlc1xuU2VjcmV0LS0-PitQb2Q6IEV4cG9zZSBzZWNyZXRzIHZpYSBtb3VudCBvciBlbnZWYXIiLCJtZXJtYWlkIjpudWxsfQ">
</div>

<h2 id="service-accounts-and-iam">Service Accounts and IAM</h2>

<p>As you might have inferred by now, there's lots of pods within our Kubernetes cluster that need IAM permissions; either to perform infrastructure actions to support our services (create ALBs, get secrets, etc) or in the normal course of a service operating (say, we're uploading a file to S3 or sending a message down an SQS queue). While permissions associated with the IAM role of a Kubernetes worker node can be inherited by all the pods on them, we really don't want that; after all, that would mean everything on the cluster would have the same role, with very broad access. We would prefer that applications running in Kubernetes be scoped to their own IAM role. Thanks to the OIDC capabilities of EKS and IAM, this is pretty easy to do.</p>

<p>EKS clusters come with their own unique OIDC URLs. These URLs, along with a unique thumbprint associated with them, allow <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html">IAM OIDC providers</a> to verify that a caller from outside of AWS (say, the EKS control plane) is who it claims to be. We can then add the OIDC provider for our new Kubernetes cluster to the trust relationship of an IAM role. (We can scope the trust relationship further, to namespace and service account name, if we really don't want the app that uploads clipart to be able to assume the role that lets it play with load balancers.)</p>

<p>With this in place, all we need to do is create a ServiceAccount object, add the IAM role we want to assume as an annotation, and associate it with our pods.
Some more EKS-specific magic then takes place in the background; the <a href="https://github.com/aws/amazon-eks-pod-identity-webhook">AWS EKS Pod Identity Webhook</a> sees that a pod is associated with a ServiceAccount that wants to use an IAM role, and makes an AWS STS call to IAM asking for a temporary web identity token for that role. If OIDC was set up right, it gets a valid web identity token, and mounts it, along with the name of the region it's running in, as environment variables in the pod. At that point, your code, and the AWS SDK (assuming you're on a version new enough to recognize web identity tokens) will run as if it's on an EC2 instance with an IAM role.</p>

<p>This way, we can associate pods with different IAM roles, and prevent services from encroaching on eachother's permissions.</p>

<div class="mermaid" style="width: 300%; margin: 0 auto; text-align: left;">
<img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5Qb2QtPj4rU2VydmljZUFjY291bnQ6IEkgd2FudCB0byBiZSBhYmxlIHRvIGRvIElBTSB0aGluZ3MuXG5TZXJ2aWNlQWNjb3VudC0-PitQb2QgSWRlbnRpdHkgV2ViaG9vazogSSB3YW50IHRoaXMgcG9kIHRvIGFzc3VtZSB0aGlzIElBTSByb2xlLlxuUG9kIElkZW50aXR5IFdlYmhvb2stPj4rQVdTIFNUUzogQ2FuIEkgZ2V0IGEgd2ViIGlkZW50aXR5IHRva2VuIGZvciB0aGlzIHJvbGU_XG5BV1MgU1RTLT4-K09JREMgUHJvdmlkZXI6IEhleSwgaXMgdGhpcyByZXF1ZXN0IGFjdHVhbGx5IGNvbWluZyBmcm9tIHRoZSBjbHVzdGVyP1xuT0lEQyBQcm92aWRlci0-PitBV1MgU1RTOiBZZXMsIEkgY2FsbGVkIHRoZW0gYmFjayBhbmQgdGhleSBzYWlkIGl0IHdhcyB0aGVtXG5BV1MgU1RTLT4-K0lBTSBSb2xlOiBJcyB0aGlzIHByaW5jaXBhbCBhbGxvd2VkIHRvIGFzc3VtZSByb2xlP1xuSUFNIFJvbGUtPj4rQVdTIFNUUzogWWVzLCB0aGUgT0lEQyBwcmluY2lwYWwgaXMgaW4gdGhlIHRydXN0IHJlbGF0aW9uc2hpcFxuQVdTIFNUUy0-PitQb2QgSWRlbnRpdHkgV2ViaG9vazogSGVyZSdzIHlvdXIgd2ViIGlkZW50aXR5IHRva2VuLlxuUG9kIElkZW50aXR5IFdlYmhvb2stLT4-K1BvZDpJJ20gY2hhbmdpbmcgeW91ciBtYW5pZmVzdCB0byBtb3VudCB0aGUgd2ViIGlkZW50aXR5IHRva2VuIGFuZCByZWdpb24gaW4gZW52VmFyc1xuUG9kLT4-K0FXUyBTUVM6IEhleSwgaGVyZSdzIGFuIFNRUyBtZXNzYWdlIiwibWVybWFpZCI6bnVsbH0">
</div>

<h1 id="the-deployment-pipeline">The Deployment Pipeline</h1>

<div class="mermaid" style="width: 150%;">
<img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoiZ3JhcGggVERcbkEoUmVwb3NpdG9yeSktLT58TWVyZ2UgUFJ8QihCdWlsZCBQaXBlbGluZSBLaWNrb2ZmKS0tPkNcbnN1YmdyYXBoIENJIFBpcGVsaW5lXG5DKEJ1aWxkIERvY2tlcmZpbGUpLS0-RFxuRChUZXN0cyktLT5FXG5FKERlcGxveSBzdGFnaW5nIGVudmlyb25tZW50KS0tPkZcbkYoRGVwbG95IHByb2R1Y3Rpb24gZW52aXJvbm1lbnQpXG5lbmRcbiUlLVxuc3ViZ3JhcGggQVdTIGluZnJhc3RydWN0dXJlXG5DLS0-TShFQ1IpXG5JLS0-TVxuTC0tPk1cbmVuZFxuJSUtXG5zdWJncmFwaCBTdGFnaW5nIHRvb2xpbmdcbkUtLT5HKEt1YmVybmV0ZXMgTWFuZmllc3QgUmVwb3NpdG9yeSkgLS0-IEgoU3RhZ2luZyBBcmdvQ0QpLS0-SShTdGFnaW5nIEt1YmVybmV0ZXMpXG4lJS1cbmVuZFxuJSUtXG5zdWJncmFwaCBQcm9kdWN0aW9uIHRvb2xpbmdcbkYtLT5KKEt1YmVybmV0ZXMgTWFuZmllc3QgUmVwb3NpdG9yeSkgLS0-IEsoUHJvZHVjdGlvbiBBcmdvQ0QpLS0-TChQcm9kdWN0aW9uIEt1YmVybmV0ZXMpXG4lJS1cbmVuZCIsIm1lcm1haWQiOm51bGx9">
</div>

<p>Early on, we elected to come up with a solution that was CI tooling-agnostic; whatever we did would not be bound to Jenkins, CircleCI, TravisCI, GitHub Actions, or the crontab running on the gaming PC in the closet. We didn't want to anchor ourselves to any of those things. Instead, we packaged all of the various scripts needed for our deployment process into a Ruby package we refer to internally as "KTool". It is very opinionated shim layer between our code repositories and the tools we use to build and push the Dockerfile, generate the Kubernetes YAML, and get that YAML applied to the Kubernetes cluster. KTool can be pulled into the pipeline, as a gem or a docker image, and be called as an executable by whatever CI tool elects to bring it in. This gives us the added ability to change and add more features to KTool without having to chase around various GitHub Actions, CircleCI orbs, or other tooling-specific components.</p>

<p>The above diagram is a bit of a simplification; depending on the service and the workflow, there's any number of various test/validate/wait steps that can fit in at any time. There's also a separate process for deploying feature branches to atomic dev environments, but that warrants its own blog post.</p>

<h2 id="dockerfile">Dockerfile</h2>

<p>The Dockerfile lives in the Git repository, so developers can add dependencies as needed. We do single-stage builds; that is, we build the Dockerfile once, and reuse the image as we promote it from dev to staging and prod. That way, we're certain that the artifacts going to prod are the same as the artifacts that we tested in staging. We Docker images in an Amazon Elastic Container Registry accessible to the dev, staging, and production Kubernetes clusters. As a best practice, we avoid use of the <code>:latest</code> tag, and instead tag our images with the commit hash of the repository, so we know exactly which image corresponds to which PR. Our repositories are set to immutable, so we can't accidentally overwrite a production image with something else.</p>

<p>From the CI pipeline's point of view, all they're doing is running "KTool build".</p>

<h2 id="kubernetes-manifest">Kubernetes Manifest</h2>

<p>We don't expect developers to write their entire Kubernetes manifests; even if we did, there would have to be some automation to put the Docker image tag (which, as mentioned above, is a commit hash) into the pod specs. Instead, we ask developers to populate a simple YAML file that answers platform-agnostic questions like "does my webapp have an ingress?", "do I have a background worker too?", "how much RAM does it have?", "what command should it run?", and "what secrets should I bring in?". KTool then picks and choses some <code>.yaml.erb</code> templates we maintain and populates them with the right values. It then feeds them into Kustomize to collate them all together, insert the image tag and application name, and make a nice, compliant YAML file ready to go into a Kubernetes cluster. It also creates an ArgoCD application definition; more on that later.</p>

<p>This gives us the added advantage of being able to update KTool with new "sane defaults"; say, one day we decide to turn on read-only filesystems, or mandate that everything have a reverse proxy sidecar to do service mesh-y things. We update KTool, and everyone just gets that in their manifest next time they deploy.</p>

<h2 id="deployment-to-kubernetes">Deployment to Kubernetes</h2>

<p>Once we have the manifest, KTool checks it into yet another Git repository, which holds all of our Kubernetes manifests.</p>

<p>It is important to us that we version-control every manifest that goes into Kubernetes, so we know when an update happened, and how to roll back. It also helps identify config drift if someone did something by hand.</p>

<p>Speaking of config drift: we use <a href="https://argoproj.github.io/cd/">ArgoCD</a> as our means of actually getting our manifests applied to the cluster. It is pointed at the aforementioned repository full of YAML manifests, and as soon as something changes in the repository, it makes it so in Kubernetes. Not only does this mean that changes are automatically applied, but it reverts config drift, heals resources that were deleted by mistake, and provides a friendly GUI for developers looking to see how their services are behaving.</p>

<p>This way, even if we somehow accidentally lose an entire EKS cluster, we can be confident that everything will come back if we install ArgoCD and point it at the repository.</p>

<h1 id="impact">Impact</h1>

<p>The unlocks from our move to Kubernetes are hard to count. Some of these deserve their own blog posts, but here's a few quick benefits in a nutshell.</p>

<ul>
<li>Developers can update their runtime dependencies. Moving to a new version of Ruby or Python is as easy as updating the Dockerfile. No more need to get a server built or modified.</li>
<li>Developers can install dependencies for their runtime. Need a specific library or binary? Go in the Dockerfile and install it. No more need to ask someone to update a Chef cookbook.</li>
<li>Since pods just grow right back if they're disrupted, and we don't store any state on the hard drive, there's absolutely no reason why we can't use spot instances... so, our entire dev and staging environments are running on spot requests!</li>
<li>If it's time to update an AMI (which, in this case, really means the AWS-managed EKS worker AMIs), we modify our managed worker groups, and the change is rolled out automatically; pods are rescheduled from old nodes to new nodes, and because we use PodDisruptionBudgets in our Deployment resources, it happens without downtime. Again, because there's nothing persistent on the compute instances other than the Docker images themselves, moving the pods around is trivial.</li>
<li>We can scale horizontally at the push of a button (by updating the Deployment spec) or automatically (using Horizontal Pod Autoscaler).</li>
</ul>

<p>Again, this blog post only touches on the surface of our Kubernetes iceberg; there's a tremendous number of little implementation details, process improvements, and discoveries that came as part of this transition. Many of them do deserve their own blog post, and now that we've set some context, those entries can come. Stay tuned!</p>

      </div>
      <div class="tb-Post-author">
        
        
        <div class="tb-Author">
  
    <div class="tb-Author-gravatar">
      <img title="Martin Bonica" src="https://www.gravatar.com/avatar/7e36be76e10ebc6ce845d46a5362b2b8?s=150">
    </div>
  
  <div class="tb-Author-info">
    
      <time pubdate datetime="2023-10-09T00:00:00-04:00">
        09 Oct 2023
      </time>
      by Martin Bonica
    
    
    <div class="tb-Author-icons">
      
      
      
    </div>
    
      <div class="tb-Author-posts">
        <a href="/authors/martin-bonica" class="sb-Btn sb-Btn--secondary sb-Btn--small">
          View All Posts
        </a>
      </div>
    
  </div>
</div>

      </div>
    </div>
    
  <div class="sb-Wrapper">
    <section id="disqus_thread">
    </section>
  </div>
  <script type="text/javascript">
    var disqus_shortname = 'custominktechnologyblog';
    var disqus_identifier = '/blog/2023/10/09/customink-on-kubernetes/';
    var disqus_title = "Custom Ink's Kubernetes Journey";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


    <div class="tb-Footer">
  <div><small>Â© 2024 CustomInk, LLC. All rights reserved.</small></div>
  <div><small><a href="https://customink.com">CustomInk</a> is a registered trademark of CustomInk LLC. "T-shirts Unite!" and the "Inky" octopus are trademarks of CustomInk, LLC.</small></div>
</div>

    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32456448-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


    <script async src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </body>
</html>
